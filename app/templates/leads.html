<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotionMade â€“ Leads</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: #111827; font-size: 16px; line-height: 1.5; }
        .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
        header { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 14px 24px; }
        .logo { font-size: 18px; font-weight: 700; color: #2563EB; }
        .auth-section { background: #fff; padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #e5e7eb; }
        .auth-section input { padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; width: 260px; margin-right: 10px; }
        .auth-section button { padding: 10px 18px; background: #2563EB; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .error { color: #dc2626; margin-top: 10px; font-size: 14px; }
        .hidden { display: none !important; }

        .controls { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-group label { font-size: 11px; color: #6b7280; font-weight: 500; text-transform: uppercase; letter-spacing: 0.02em; }
        .control-group input, .control-group select { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; min-width: 120px; font-size: 15px; }
        .control-group input[type="number"] { width: 80px; }
        .trade-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-trade { padding: 10px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; background: #f3f4f6; color: #374151; border: 2px solid #e5e7eb; font-weight: 500; }
        .btn-trade:hover { background: #e5e7eb; }
        .btn-trade.selected { background: #2563EB; color: white; border-color: #2563EB; }
        .btn-run { padding: 14px 28px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; border: none; background: #2563EB; color: white; }
        .btn-run:hover:not(:disabled) { background: #1d4ed8; }
        .btn-run:disabled { opacity: 0.7; cursor: not-allowed; }
        .progress-msg { font-size: 14px; color: #6b7280; margin-left: 12px; }
        .progress-msg.active { color: #2563EB; font-weight: 500; }

        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 12px; color: #6b7280; }
        .log-header a { color: #2563EB; cursor: pointer; text-decoration: none; }
        .log-header a:hover { text-decoration: underline; }
        .log-panel { background: #1f2937; color: #e5e7eb; border-radius: 8px; padding: 14px 16px; font-family: ui-monospace, monospace; font-size: 12px; max-height: 180px; overflow-y: auto; margin-bottom: 20px; }
        .log-panel .log-entry { margin-bottom: 4px; }
        .log-panel .log-phase { color: #93c5fd; }
        .log-panel .log-time { color: #9ca3af; margin-right: 8px; font-size: 11px; }
        .run-summary { background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 14px; color: #065f46; }
        .no-email-section { margin-top: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }
        .no-email-section summary { padding: 10px 14px; cursor: pointer; font-size: 13px; color: #6b7280; }
        .expand-content .value.email-body { min-height: 80px; }
        .daily-counter-wrap { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 14px; color: #374151; }
        .daily-counter-wrap .daily-sent { font-weight: 500; }
        .daily-limit-warning { font-size: 13px; color: #b45309; margin-bottom: 8px; }
        .daily-limit-block { font-size: 13px; color: #dc2626; margin-bottom: 8px; font-weight: 500; }
        .btn-limit-gear { background: none; border: none; cursor: pointer; padding: 4px; color: #6b7280; font-size: 16px; }
        .btn-limit-gear:hover { color: #374151; }
        .limit-dropdown { position: absolute; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 6px 0; z-index: 50; min-width: 100px; left: 0; top: 100%; margin-top: 4px; }
        .limit-dropdown button { display: block; width: 100%; padding: 8px 14px; text-align: left; border: none; background: none; cursor: pointer; font-size: 13px; }
        .limit-dropdown button:hover { background: #f3f4f6; }

        .pipeline-status-bar { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; font-size: 14px; display: flex; flex-wrap: wrap; gap: 8px 16px; align-items: center; }
        .pipeline-status-bar .stat-sent { color: #1d4ed8; font-weight: 600; }
        .pipeline-status-bar .stat-sent.at-limit { color: #dc2626; }
        .pipeline-status-bar .stat-ready { color: #059669; font-weight: 600; }
        .pipeline-status-bar .stat-total { color: #6b7280; }

        .pipeline-section { margin-bottom: 20px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; }
        .pipeline-section.ready-section { background: #f0fdf4; border-color: #bbf7d0; }
        .pipeline-section.sent-section { background: #f9fafb; border-color: #e5e7eb; }
        .pipeline-section-header { padding: 14px 18px; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .pipeline-section.ready-section .pipeline-section-header { background: #dcfce7; color: #166534; }
        .pipeline-section.sent-section .pipeline-section-header { background: #f3f4f6; color: #374151; cursor: pointer; }
        .pipeline-section.sent-section .pipeline-section-header:hover { background: #e5e7eb; }
        .pipeline-section-header summary { list-style: none; }
        .pipeline-section-header summary::-webkit-details-marker { display: none; }

        .send-all-wrap { display: flex; align-items: center; gap: 10px; }
        .btn-send-all { padding: 12px 22px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; border: none; background: #059669; color: white; }
        .btn-send-all:hover:not(:disabled) { background: #047857; }
        .btn-send-all:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-send-all.sending { background: #2563EB; }
        .btn-send-all.done { background: #059669; }
        .send-progress-bar-wrap { height: 6px; background: #e5e7eb; border-radius: 3px; width: 160px; overflow: hidden; }
        .send-progress-bar-fill { height: 100%; background: #2563EB; border-radius: 3px; transition: width 0.2s; }

        .pipeline-table-wrap { overflow-x: auto; }
        table.pipeline-table { width: 100%; border-collapse: collapse; }
        .pipeline-table th, .pipeline-table td { padding: 12px 14px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.06); vertical-align: middle; font-size: 14px; }
        .pipeline-table th { font-weight: 600; font-size: 11px; text-transform: uppercase; color: #6b7280; letter-spacing: 0.02em; }
        .pipeline-section.ready-section .pipeline-table tbody tr { background: #f0fdf4; }
        .pipeline-section.ready-section .pipeline-table tbody tr:hover { background: #dcfce7; }
        .pipeline-section.sent-section .pipeline-table tbody tr { background: #f9fafb; color: #6b7280; }
        .pipeline-section.sent-section .pipeline-table tbody tr:hover { background: #f3f4f6; }
        .pipeline-table .subject-preview { max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; }
        .pipeline-table .sent-at { font-size: 12px; color: #6b7280; }
        .btn-preview { padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
        .btn-preview:hover { background: #e5e7eb; }
        .btn-open-gmail { padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; background: #ea4335; color: white; }
        .btn-open-gmail:hover { background: #d33426; }
        .btn-open-gmail:disabled { opacity: 0.5; cursor: not-allowed; }

        .expand-row-pipeline { background: #fff; }
        .expand-row-pipeline td { padding: 16px 14px; border-bottom: 1px solid #e5e7eb; vertical-align: top; font-size: 13px; }
        .expand-row-pipeline .label { font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px; }
        .expand-row-pipeline .value { white-space: pre-wrap; word-break: break-word; }
        .expand-row-pipeline .value.body { background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; }

        .btn-backup-csv { padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
        .btn-backup-csv:hover { background: #e5e7eb; }
        .btn-refresh { padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
        .btn-refresh:hover { background: #e5e7eb; }

        .footer-actions { text-align: center; padding: 20px 0; }
        .footer-actions .btn-export { padding: 8px 16px; font-size: 13px; border-radius: 8px; cursor: pointer; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
        .footer-actions .btn-export:hover { background: #e5e7eb; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: #fff; border-radius: 12px; max-width: 560px; width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid #e5e7eb; font-weight: 600; font-size: 16px; }
        .modal-body { padding: 20px; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #374151; }
        .modal-body ol { margin: 0 0 14px 0; padding-left: 20px; }
        .modal-body li { margin-bottom: 6px; }
        .modal-body pre { background: #1f2937; color: #e5e7eb; padding: 14px; border-radius: 8px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; margin: 12px 0; text-align: left; }
        .modal-footer { padding: 14px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end; }
        .btn-copy-script { padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; background: #2563EB; color: white; border: none; }
        .btn-copy-script:hover { background: #1d4ed8; }
        .btn-modal-close { padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
        .btn-modal-close:hover { background: #e5e7eb; }
    </style>
</head>
<body>
    <header>
        <span class="logo">MotionMade Leads</span>
    </header>
    <div class="container">
        <div class="auth-section" id="authSection">
            <input type="password" id="adminToken" placeholder="Admin token" />
            <button id="loginBtn" class="auth-section button" style="padding:10px 18px;background:#2563EB;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:500;">Login</button>
            <div id="authError" class="error"></div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="controls">
                <div class="control-group">
                    <label>Trade</label>
                    <div class="trade-buttons">
                        <button type="button" class="btn-trade selected" data-trade="Bond Cleaning">Bond Cleaning</button>
                        <button type="button" class="btn-trade" data-trade="House Cleaning">House Cleaning</button>
                        <button type="button" class="btn-trade" data-trade="Plumber">Plumber</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>City / region</label>
                    <select id="city">
                        <option value="Brisbane" selected>Brisbane</option>
                        <option value="Gold Coast">Gold Coast</option>
                        <option value="Sunshine Coast">Sunshine Coast</option>
                        <option value="Sydney">Sydney</option>
                        <option value="Melbourne">Melbourne</option>
                        <option value="Perth">Perth</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Suburb</label>
                    <select id="suburb"><option value="">All</option></select>
                </div>
                <div class="control-group">
                    <label>Target leads</label>
                    <input type="number" id="targetCount" min="5" max="50" value="20" />
                </div>
                <div style="display:flex;align-items:center;flex:1;min-width:200px;">
                    <button type="button" id="runAll" class="btn-run">ðŸš€ Find Leads & Write Emails</button>
                    <span id="progressMsg" class="progress-msg"></span>
                </div>
            </div>

            <div class="log-header"><span>Live log</span><a id="clearLog" href="#">Clear</a></div>
            <div class="log-panel" id="logPanel"></div>
            <div id="runSummary" class="run-summary hidden"></div>

            <div class="daily-counter-wrap">
                <span id="dailySentText" class="daily-sent">Emails sent today: 0/20</span>
                <div style="position:relative;">
                    <button type="button" id="dailyLimitGear" class="btn-limit-gear" title="Daily limit">âš™</button>
                    <div id="limitDropdown" class="limit-dropdown hidden">
                        <button type="button" data-limit="10">10 per day</button>
                        <button type="button" data-limit="15">15 per day</button>
                        <button type="button" data-limit="20">20 per day</button>
                        <button type="button" data-limit="30">30 per day</button>
                        <button type="button" data-limit="50">50 per day</button>
                    </div>
                </div>
            </div>
            <div id="dailyLimitWarning" class="daily-limit-warning hidden">Almost at daily limit. Slow down to avoid spam flags.</div>
            <div id="dailyLimitBlock" class="daily-limit-block hidden">Daily limit reached. Send more tomorrow.</div>

            <div id="pipelineStatusBar" class="pipeline-status-bar hidden">
                <span>Today: <span id="statSent" class="stat-sent">0</span> / <span id="statLimit">20</span> limit</span>
                <span>|</span>
                <span><span id="statReady" class="stat-ready">0</span> ready to send</span>
                <span>|</span>
                <span><span id="statTotal" class="stat-total">0</span> total leads</span>
                <span style="margin-left:auto;"><button type="button" id="refreshLeads" class="btn-refresh">Refresh</button></span>
            </div>

            <div id="pipelineReadySection" class="pipeline-section ready-section hidden">
                <div class="pipeline-section-header">
                    <span>ðŸ“¬ Ready to Send (<span id="readyCount">0</span>)</span>
                    <div class="send-all-wrap">
                        <button type="button" id="sendAllNowBtn" class="btn-send-all hidden">
                            <span id="sendBtnLabel">Send 0 Emails Now</span>
                            <span id="sendBtnProgress" style="display:none;"><span id="sendProgressText">Sending... 0 of 0</span> <div class="send-progress-bar-wrap" style="display:inline-block;vertical-align:middle;width:120px;margin-left:6px;"><div id="sendProgressBar" class="send-progress-bar-fill" style="width:0%;"></div></div></span>
                            <span id="sendBtnDone" style="display:none;">âœ… All sent!</span>
                        </button>
                        <button type="button" id="prepareSendGmail" class="btn-backup-csv hidden" title="Backup: download CSV + Apps Script">CSV backup</button>
                    </div>
                </div>
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table" id="leadsReadyTable">
                        <thead><tr><th>Business</th><th>Email</th><th>Subject</th><th></th></tr></thead>
                        <tbody id="leadsReadyBody"></tbody>
                    </table>
                </div>
            </div>

            <details id="pipelineSentSection" class="pipeline-section sent-section hidden" style="margin-bottom:16px;">
                <summary class="pipeline-section-header">
                    <span>âœ… Sent (<span id="sentCount">0</span>)</span>
                </summary>
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table" id="leadsSentTable">
                        <thead><tr><th>Business</th><th>Email</th><th>Subject</th><th>When</th></tr></thead>
                        <tbody id="leadsSentBody"></tbody>
                    </table>
                </div>
            </details>

            <details id="noEmailSection" class="no-email-section hidden">
                <summary id="noEmailSummary" style="padding:10px 14px;margin:0;font-size:13px;color:#6b7280;cursor:pointer;">0 leads without email (hidden)</summary>
                <div id="noEmailList" style="padding:8px 14px 12px;font-size:13px;color:#6b7280;"></div>
            </details>

            <div class="footer-actions">
                <button type="button" id="exportCsv" class="btn-export">Export CSV</button>
            </div>
        </div>
    </div>

    <div id="gmailScriptModal" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-header">Download &amp; Send via Gmail</div>
            <div class="modal-body">
                <p><strong>1.</strong> CSV has been downloaded. Open Google Sheets, create a new sheet, then <strong>File â†’ Import â†’ Upload</strong> and select <code>leads_gmail.csv</code>. Put the file in the first column (replace or paste).</p>
                <p><strong>2.</strong> In Sheets: <strong>Extensions â†’ Apps Script</strong>. Delete any sample code and paste the script below. Save (Ctrl+S), then run <code>sendEmails</code> (select it from the dropdown and click Run). Authorize when prompted. The script sends each row with a 30 second delay.</p>
                <pre id="gmailScriptPre"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" id="copyScriptBtn" class="btn-copy-script">Copy script</button>
                <button type="button" id="closeScriptModalBtn" class="btn-modal-close">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let adminToken = '';

        function getHeaders() {
            return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminToken };
        }

        function getSelectedTrade() {
            var sel = document.querySelector('.btn-trade.selected');
            return (sel && sel.getAttribute('data-trade')) || 'Plumber';
        }

        document.querySelectorAll('.btn-trade').forEach(function(btn) {
            btn.onclick = function() {
                document.querySelectorAll('.btn-trade').forEach(function(b) { b.classList.remove('selected'); });
                this.classList.add('selected');
            };
        });

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        function formatSentAt(updatedAtStr) {
            if (!updatedAtStr) return 'Sent';
            var d = new Date(updatedAtStr);
            if (isNaN(d.getTime())) return 'Sent';
            var now = new Date();
            var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var diffMs = now - d;
            var diffMins = Math.floor(diffMs / 60000);
            var diffHours = Math.floor(diffMs / 3600000);
            var diffDays = Math.floor(diffMs / 86400000);
            if (diffMins < 1) return 'Sent just now';
            if (diffMins < 60) return 'Sent ' + diffMins + ' min' + (diffMins === 1 ? '' : 's') + ' ago';
            if (d >= today) {
                var h = d.getHours(); var m = d.getMinutes(); var am = h < 12; var h12 = h % 12 || 12;
                return 'Sent today ' + h12 + ':' + (m < 10 ? '0' : '') + m + (am ? 'am' : 'pm');
            }
            if (diffDays === 1) return 'Sent yesterday';
            if (diffDays < 7) return 'Sent ' + diffDays + ' days ago';
            return 'Sent ' + d.toLocaleDateString();
        }

        document.getElementById('loginBtn').onclick = async function() {
            const token = document.getElementById('adminToken').value.trim();
            if (!token) { document.getElementById('authError').textContent = 'Token required'; return; }
            adminToken = token;
            document.getElementById('authError').textContent = '';
            try {
                const r = await fetch(API_BASE + '/api/leads', { headers: getHeaders() });
                if (r.status === 401) { document.getElementById('authError').textContent = 'Invalid token'; return; }
                if (!r.ok) throw new Error('HTTP ' + r.status);
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadSuburbs();
                loadLeads();
                loadDailySent();
                startLogPolling();
            document.getElementById('city').onchange = function() { loadSuburbs(); };
            var gear = document.getElementById('dailyLimitGear');
            var limitDropdown = document.getElementById('limitDropdown');
            if (gear && limitDropdown) {
                gear.onclick = function(e) { e.stopPropagation(); limitDropdown.classList.toggle('hidden'); };
                limitDropdown.onclick = function(e) { e.stopPropagation(); };
                limitDropdown.querySelectorAll('button').forEach(function(btn) {
                    btn.onclick = function() {
                        var limit = parseInt(this.getAttribute('data-limit'), 10);
                        try { localStorage.setItem('leads_daily_limit', String(limit)); } catch (z) {}
                        limitDropdown.classList.add('hidden');
                        loadDailySent();
                    };
                });
            }
            document.addEventListener('click', function() { if (limitDropdown) limitDropdown.classList.add('hidden'); });
            } catch (e) {
                document.getElementById('authError').textContent = e.message || 'Login failed';
            }
        };

        async function loadSuburbs() {
            var cityEl = document.getElementById('city');
            var city = (cityEl && cityEl.value) ? cityEl.value : 'Brisbane';
            var sel = document.getElementById('suburb');
            var fallback = '<option value="">All</option>';
            try {
                var r = await fetch(API_BASE + '/api/leads/suburbs?city=' + encodeURIComponent(city), { headers: getHeaders() });
                if (!r.ok) { sel.innerHTML = fallback; return; }
                var data = await r.json();
                sel.innerHTML = '<option value="">All</option>' + (data.suburbs || []).map(function(s) { return '<option value="' + escapeHtml(s) + '">' + escapeHtml(s) + '</option>'; }).join('');
            } catch (e) {
                sel.innerHTML = fallback;
            }
        }

        let leadsCache = [];
        var dailySentCount = 0;
        var dailyLimit = 20;

        function getDailyLimit() {
            try {
                var v = localStorage.getItem('leads_daily_limit');
                if (v) { var n = parseInt(v, 10); if ([10,15,20,30,50].indexOf(n) >= 0) return n; }
            } catch (e) {}
            return 20;
        }

        async function loadDailySent() {
            dailyLimit = getDailyLimit();
            try {
                var r = await fetch(API_BASE + '/api/leads/daily-sent-count', { headers: getHeaders() });
                if (!r.ok) return;
                var data = await r.json();
                dailySentCount = data.count != null ? data.count : 0;
                if (data.limit != null) dailyLimit = data.limit;
            } catch (e) { return; }
            var textEl = document.getElementById('dailySentText');
            var warnEl = document.getElementById('dailyLimitWarning');
            var blockEl = document.getElementById('dailyLimitBlock');
            var prepareBtn = document.getElementById('prepareSendGmail');
            var sendAllBtn = document.getElementById('sendAllNowBtn');
            var statSentEl = document.getElementById('statSent');
            var statLimitEl = document.getElementById('statLimit');
            if (textEl) textEl.textContent = 'Emails sent today: ' + dailySentCount + '/' + dailyLimit;
            if (statSentEl) { statSentEl.textContent = dailySentCount; statSentEl.classList.toggle('at-limit', dailySentCount >= dailyLimit); }
            if (statLimitEl) statLimitEl.textContent = dailyLimit;
            if (warnEl) { if (dailySentCount >= Math.max(1, dailyLimit - 5)) warnEl.classList.remove('hidden'); else warnEl.classList.add('hidden'); }
            if (blockEl) { if (dailySentCount >= dailyLimit) blockEl.classList.remove('hidden'); else blockEl.classList.add('hidden'); }
            if (prepareBtn) {
                if (dailySentCount >= dailyLimit) { prepareBtn.disabled = true; prepareBtn.title = 'Daily limit reached.'; }
                else { prepareBtn.disabled = false; prepareBtn.title = 'Backup: download CSV + Apps Script'; }
            }
            if (sendAllBtn && !sendAllBtn.classList.contains('sending')) {
                if (dailySentCount >= dailyLimit) { sendAllBtn.disabled = true; sendAllBtn.title = 'Daily limit reached. Send more tomorrow.'; }
                else { sendAllBtn.disabled = false; sendAllBtn.title = ''; }
            }
            document.querySelectorAll('.btn-open-gmail').forEach(function(btn) {
                if (dailySentCount >= dailyLimit) { btn.disabled = true; btn.title = 'Daily limit reached.'; }
                else { btn.disabled = false; btn.title = ''; }
            });
        }

        async function loadLeads() {
            var trade = getSelectedTrade();
            var suburb = document.getElementById('suburb').value;
            var url = API_BASE + '/api/leads?';
            if (trade) url += 'trade_type=' + encodeURIComponent(trade) + '&';
            if (suburb) url += 'suburb=' + encodeURIComponent(suburb) + '&';
            const r = await fetch(url, { headers: getHeaders() });
            if (!r.ok) return;
            const data = await r.json();
            leadsCache = data.leads || [];
            renderLeads(leadsCache);
            updateSendAllButton();
            loadDailySent();
        }

        function copyFullEmail(lead) {
            const to = (lead.email || '').trim();
            const subj = (lead.email_subject || '').trim();
            const body = (lead.email_body || '').trim();
            return 'To: ' + to + '\nSubject: ' + subj + '\n\n' + body;
        }

        function updateSendAllButton() {
            const withEmail = leadsCache.filter(function(l) { return (l.email || '').trim().length > 0; });
            const ready = leadsCache.filter(l => l.status === 'ready' && l.email);
            const sent = leadsCache.filter(l => l.status === 'emailed');
            const nReady = ready.length;
            const nSent = sent.length;
            const total = withEmail.length;
            var statusBar = document.getElementById('pipelineStatusBar');
            var readySection = document.getElementById('pipelineReadySection');
            var sentSection = document.getElementById('pipelineSentSection');
            if (statusBar) { if (total > 0) statusBar.classList.remove('hidden'); else statusBar.classList.add('hidden'); }
            document.getElementById('statReady').textContent = nReady;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('readyCount').textContent = nReady;
            document.getElementById('sentCount').textContent = nSent;
            if (readySection) { if (nReady > 0) readySection.classList.remove('hidden'); else readySection.classList.add('hidden'); }
            if (sentSection) { if (nSent > 0) sentSection.classList.remove('hidden'); else sentSection.classList.add('hidden'); }
            var sendAllBtn = document.getElementById('sendAllNowBtn');
            var sendBtnLabel = document.getElementById('sendBtnLabel');
            var sendBtnCount = document.getElementById('sendBtnCount');
            var prepareBtn = document.getElementById('prepareSendGmail');
            if (sendAllBtn) {
                if (nReady > 0) {
                    sendAllBtn.classList.remove('hidden');
                    var canSend = Math.max(0, dailyLimit - dailySentCount);
                    var toSend = Math.min(nReady, canSend);
                    if (sendBtnLabel) {
                        sendBtnLabel.style.display = '';
                        sendBtnLabel.textContent = (toSend < nReady && toSend > 0) ? 'Send ' + toSend + ' of ' + nReady + ' (daily limit: ' + dailyLimit + ')' : 'Send ' + nReady + ' Emails Now';
                    }
                } else sendAllBtn.classList.add('hidden');
            }
            if (prepareBtn) { if (nReady > 0) prepareBtn.classList.remove('hidden'); else prepareBtn.classList.add('hidden'); }
        }

        function renderLeads(leads) {
            const withEmail = leads.filter(function(l) { return (l.email || '').trim().length > 0; });
            const noEmail = leads.filter(function(l) { return !(l.email || '').trim().length; });
            const ready = withEmail.filter(function(l) { return l.status === 'ready'; });
            const sent = withEmail.filter(function(l) { return l.status === 'emailed'; });

            var readyBody = document.getElementById('leadsReadyBody');
            var sentBody = document.getElementById('leadsSentBody');
            if (!readyBody || !sentBody) return;

            if (ready.length === 0) readyBody.innerHTML = '<tr><td colspan="4" style="padding:16px;color:#6b7280;font-size:14px;">No emails ready. Click Find Leads & Write Emails first.</td></tr>';
            else {
                var html = '';
                ready.forEach(function(lead) {
                    var subj = (lead.email_subject || '').trim();
                    var subjPreview = subj.length > 50 ? subj.substring(0, 50) + 'â€¦' : subj;
                    html += '<tr class="main-row ready-row" data-id="' + lead.id + '">' +
                        '<td>' + escapeHtml(lead.business_name || '') + '</td>' +
                        '<td>' + escapeHtml(lead.email || '') + '</td>' +
                        '<td class="subject-preview" title="' + escapeHtml(lead.email_subject || '') + '">' + escapeHtml(subjPreview || 'â€“') + '</td>' +
                        '<td><button type="button" class="btn-preview" data-id="' + lead.id + '">Preview</button> <button type="button" class="btn-open-gmail" data-id="' + lead.id + '">Open in Gmail</button></td></tr>';
                    html += '<tr class="expand-row-pipeline expand-ready-' + lead.id + '" style="display:none;"><td colspan="4"><div class="label">Subject</div><div class="value">' + escapeHtml(lead.email_subject || '') + '</div><div class="label">Body</div><div class="value body">' + escapeHtml(lead.email_body || '') + '</div></td></tr>';
                });
                readyBody.innerHTML = html;
            }

            if (sent.length === 0) sentBody.innerHTML = '<tr><td colspan="4" style="padding:16px;color:#6b7280;font-size:14px;">No emails sent yet.</td></tr>';
            else {
                var html2 = '';
                sent.forEach(function(lead) {
                    var subj = (lead.email_subject || '').trim();
                    var subjPreview = subj.length > 45 ? subj.substring(0, 45) + 'â€¦' : subj;
                    html2 += '<tr><td>' + escapeHtml(lead.business_name || '') + '</td><td>' + escapeHtml(lead.email || '') + '</td><td class="subject-preview">' + escapeHtml(subjPreview || 'â€“') + '</td><td class="sent-at">' + formatSentAt(lead.updated_at) + '</td></tr>';
                });
                sentBody.innerHTML = html2;
            }

            var noSection = document.getElementById('noEmailSection');
            var noSummary = document.getElementById('noEmailSummary');
            var noList = document.getElementById('noEmailList');
            if (noSection && noSummary) {
                noSummary.textContent = noEmail.length + ' leads without email (hidden)';
                if (noList) noList.textContent = noEmail.length ? noEmail.map(function(l) { return l.business_name || 'Unknown'; }).join(', ') : '';
                if (noEmail.length) noSection.classList.remove('hidden'); else noSection.classList.add('hidden');
            }

            if (readyBody) {
                readyBody.querySelectorAll('.btn-preview').forEach(function(btn) {
                    btn.onclick = function(e) { e.stopPropagation(); var id = this.getAttribute('data-id'); var expand = document.querySelector('.expand-ready-' + id); if (expand) { var visible = expand.style.display !== 'none'; document.querySelectorAll('.expand-row-pipeline').forEach(function(r) { r.style.display = 'none'; }); expand.style.display = visible ? 'none' : 'table-row'; } };
                });
                readyBody.querySelectorAll('.btn-open-gmail').forEach(function(btn) {
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        if (dailySentCount >= dailyLimit) { alert('Daily limit reached. Send more tomorrow.'); return; }
                        var id = btn.getAttribute('data-id');
                        var lead = leadsCache.find(function(l) { return String(l.id) === id; });
                        if (!lead || !lead.email) return;
                        var mailto = 'mailto:' + lead.email + '?subject=' + encodeURIComponent((lead.email_subject || '').trim()) + '&body=' + encodeURIComponent((lead.email_body || '').trim());
                        window.open(mailto, '_blank');
                    };
                });
            }
        }

        const STEPS = [
            { key: 'discovery', label: 'Finding businesses...' },
            { key: 'audit', label: 'Auditing websites...' },
            { key: 'email', label: 'Writing emails...' }
        ];

        document.getElementById('clearLog').onclick = async function(e) {
            e.preventDefault();
            try {
                await fetch(API_BASE + '/api/leads/autopilot/clear-log', { method: 'POST', headers: getHeaders() });
            } catch (err) {}
            document.getElementById('logPanel').innerHTML = '';
        };

        var GMAIL_APPS_SCRIPT = 'function sendEmails() {\n' +
            '  var sheet = SpreadsheetApp.getActiveSheet();\n' +
            '  var data = sheet.getDataRange().getValues();\n' +
            '  var headers = data[0];\n' +
            '  var emailCol = headers.indexOf("Email Address");\n' +
            '  var subjectCol = headers.indexOf("Email Subject");\n' +
            '  var bodyCol = headers.indexOf("Email Body");\n' +
            '  var sent = 0;\n' +
            '  for (var i = 1; i < data.length; i++) {\n' +
            '    var email = data[i][emailCol];\n' +
            '    var subject = data[i][subjectCol];\n' +
            '    var body = data[i][bodyCol];\n' +
            '    if (email && subject && body) {\n' +
            '      try {\n' +
            '        GmailApp.sendEmail(email, subject, body, {\n' +
            '          name: "Abbed",\n' +
            '          replyTo: "abbed@motionmadebne.com.au"\n' +
            '        });\n' +
            '        sheet.getRange(i + 1, headers.length + 1).setValue("SENT");\n' +
            '        sent++;\n' +
            '        Utilities.sleep(30000);\n' +
            '      } catch (e) {\n' +
            '        sheet.getRange(i + 1, headers.length + 1).setValue("FAILED: " + e.message);\n' +
            '      }\n' +
            '    }\n' +
            '  }\n' +
            '  SpreadsheetApp.getUi().alert("Done! Sent " + sent + " emails.");\n' +
            '}';

        document.getElementById('runAll').onclick = async function() {
            lastLogId = 0;
            const btn = this;
            const progressEl = document.getElementById('progressMsg');
            const summaryEl = document.getElementById('runSummary');
            btn.disabled = true;
            if (summaryEl) summaryEl.classList.add('hidden');
            progressEl.classList.add('active');
            var trade = getSelectedTrade();
            var suburb = document.getElementById('suburb').value;
            const target = Math.min(50, Math.max(5, parseInt(document.getElementById('targetCount').value, 10) || 20));
            var discoveryResp = {}, auditResp = {}, emailResp = {};

            for (var i = 0; i < STEPS.length; i++) {
                progressEl.textContent = 'Step ' + (i + 1) + '/3: ' + STEPS[i].label;
                try {
                    if (STEPS[i].key === 'discovery') {
                        var r = await fetch(API_BASE + '/api/leads/autopilot/discovery', {
                            method: 'POST', headers: getHeaders(),
                            body: JSON.stringify({ trade_type: trade, suburb: suburb, city: (document.getElementById('city') && document.getElementById('city').value) || 'Brisbane', target_count: target })
                        });
                        discoveryResp = await r.json().catch(function() { return {}; });
                        if (!r.ok) throw new Error(discoveryResp.detail || 'Discovery failed');
                    } else if (STEPS[i].key === 'audit') {
                        r = await fetch(API_BASE + '/api/leads/autopilot/audit', { method: 'POST', headers: getHeaders(), body: JSON.stringify({}) });
                        auditResp = await r.json().catch(function() { return {}; });
                        if (!r.ok) throw new Error(auditResp.detail || 'Audit failed');
                    } else {
                        r = await fetch(API_BASE + '/api/leads/autopilot/email-writing', { method: 'POST', headers: getHeaders(), body: JSON.stringify({}) });
                        emailResp = await r.json().catch(function() { return {}; });
                        if (!r.ok) throw new Error(emailResp.detail || 'Email writing failed');
                    }
                    await loadLeads();
                } catch (e) {
                    var msg = (e && e.message) ? e.message : 'Step failed';
                    progressEl.textContent = 'Step ' + (i + 1) + '/3 failed: ' + msg + '. Continuingâ€¦';
                    await new Promise(function(res) { setTimeout(res, 2000); });
                }
            }
            progressEl.textContent = '';
            progressEl.classList.remove('active');
            btn.disabled = false;
            await loadLeads();

            if (summaryEl) {
                var inserted = discoveryResp.inserted != null ? discoveryResp.inserted : -1;
                if (inserted === 0) {
                    var loc = (discoveryResp.suburb_searched || suburb || (document.getElementById('city') && document.getElementById('city').value) || 'Brisbane');
                    summaryEl.textContent = 'No new businesses found for ' + trade + ' in ' + loc + '. Try a different suburb or trade.';
                } else {
                    var totalFound = discoveryResp.total_found != null ? discoveryResp.total_found : (discoveryResp.inserted != null ? discoveryResp.inserted : 0);
                    var withEmail = leadsCache.filter(function(l) { return (l.email || '').trim().length > 0; }).length;
                    var readyToSend = leadsCache.filter(function(l) { return l.status === 'ready' && l.email; }).length;
                    summaryEl.textContent = (inserted > 0 ? inserted + ' new leads found. ' : '') + 'Found ' + totalFound + ' businesses, ' + withEmail + ' had emails, ' + readyToSend + ' emails written and ready to send.';
                }
                summaryEl.classList.remove('hidden');
            }
        };

        function csvEscape(s) {
            if (s == null) return '""';
            var t = String(s).replace(/"/g, '""');
            if (/[",\r\n]/.test(t)) return '"' + t + '"';
            return t;
        }
        var sendProgressInterval = null;
        document.getElementById('sendAllNowBtn').onclick = async function() {
            if (dailySentCount >= dailyLimit) { alert('Daily limit reached. Send more tomorrow.'); return; }
            var ready = leadsCache.filter(function(l) { return l.status === 'ready' && l.email; });
            if (!ready.length) return;
            var btn = this;
            var summaryEl = document.getElementById('runSummary');
            var progressEl = document.getElementById('progressMsg');
            var sendBtnLabel = document.getElementById('sendBtnLabel');
            var sendBtnProgress = document.getElementById('sendBtnProgress');
            var sendBtnDone = document.getElementById('sendBtnDone');
            var sendProgressText = document.getElementById('sendProgressText');
            var sendProgressBar = document.getElementById('sendProgressBar');
            btn.disabled = true;
            btn.classList.add('sending');
            if (summaryEl) summaryEl.classList.add('hidden');
            progressEl.textContent = 'Sending emails...';
            progressEl.classList.add('active');
            if (sendBtnLabel) sendBtnLabel.style.display = 'none';
            if (sendBtnDone) sendBtnDone.style.display = 'none';
            try {
                var r = await fetch(API_BASE + '/api/leads/autopilot/send-ready', { method: 'POST', headers: getHeaders() });
                var data = await r.json().catch(function() { return {}; });
                if (!data.ok) {
                    if ((data.message || '').indexOf('Already sending') !== -1) {
                        if (summaryEl) { summaryEl.textContent = 'Already sending. Check the log below for progress.'; summaryEl.classList.remove('hidden'); }
                    } else {
                        if (summaryEl) { summaryEl.textContent = data.message || 'Send failed'; summaryEl.classList.remove('hidden'); }
                    }
                    if (sendBtnLabel) sendBtnLabel.style.display = '';
                    btn.classList.remove('sending');
                    btn.disabled = false;
                    progressEl.textContent = '';
                    progressEl.classList.remove('active');
                    return;
                }
                var totalToSend = data.to_send != null ? data.to_send : 0;
                if (totalToSend === 0) {
                    if (summaryEl) { summaryEl.textContent = data.message || 'No emails to send.'; summaryEl.classList.remove('hidden'); }
                    if (sendBtnLabel) sendBtnLabel.style.display = '';
                    btn.classList.remove('sending');
                    btn.disabled = false;
                    progressEl.textContent = '';
                    progressEl.classList.remove('active');
                    return;
                }
                if (sendBtnProgress) { sendBtnProgress.style.display = ''; sendProgressText.textContent = 'Sending... 0 of ' + totalToSend; if (sendProgressBar) sendProgressBar.style.width = '0%'; }
                var logR = await fetch(API_BASE + '/api/leads/autopilot/log?limit=1', { headers: getHeaders() }).catch(function() { return { ok: false }; });
                if (logR.ok) { var logData = await logR.json(); if ((logData.log || []).length) lastLogId = logData.log[logData.log.length - 1].id || lastLogId; }
                var sentSoFar = 0;
                var completed = false;
                sendProgressInterval = setInterval(async function() {
                    if (completed) return;
                    try {
                        var r2 = await fetch(API_BASE + '/api/leads/autopilot/log?since_id=' + lastLogId + '&limit=200', { headers: getHeaders() });
                        if (!r2.ok) return;
                        var logData2 = await r2.json();
                        (logData2.log || []).forEach(function(entry) {
                            if (entry.id > lastLogId) lastLogId = entry.id;
                            if (entry.phase === 'send') {
                                if ((entry.message || '').indexOf('Sent âœ“') !== -1) sentSoFar++;
                                if ((entry.message || '').indexOf('Sending complete:') !== -1) completed = true;
                            }
                        });
                        if (sendProgressText) sendProgressText.textContent = 'Sending... ' + sentSoFar + ' of ' + totalToSend;
                        if (sendProgressBar) sendProgressBar.style.width = (totalToSend ? Math.min(100, (sentSoFar / totalToSend) * 100) : 0) + '%';
                        if (completed) {
                            if (sendProgressInterval) { clearInterval(sendProgressInterval); sendProgressInterval = null; }
                            if (sendBtnProgress) sendBtnProgress.style.display = 'none';
                            if (sendBtnDone) { sendBtnDone.style.display = ''; sendBtnDone.textContent = 'âœ… All sent!'; }
                            if (sendProgressBar) sendProgressBar.style.width = '100%';
                            var lastMsg = (logData2.log || []).filter(function(e) { return (e.message || '').indexOf('Sending complete:') !== -1; }).pop();
                            if (summaryEl && lastMsg) { summaryEl.textContent = lastMsg.message || ''; summaryEl.classList.remove('hidden'); }
                            await loadLeads();
                            loadDailySent();
                            setTimeout(function() {
                                if (sendBtnDone) sendBtnDone.style.display = 'none';
                                if (sendBtnLabel) sendBtnLabel.style.display = '';
                                btn.classList.remove('sending');
                                btn.disabled = false;
                                updateSendAllButton();
                            }, 2000);
                        }
                    } catch (e) {}
                }, 2000);
            } catch (e) {
                if (sendProgressInterval) { clearInterval(sendProgressInterval); sendProgressInterval = null; }
                if (sendBtnProgress) sendBtnProgress.style.display = 'none';
                if (sendBtnLabel) sendBtnLabel.style.display = '';
                btn.classList.remove('sending');
                btn.disabled = false;
                if (summaryEl) { summaryEl.textContent = 'Send failed: ' + (e.message || e); summaryEl.classList.remove('hidden'); }
            }
            progressEl.textContent = '';
            progressEl.classList.remove('active');
        };

        document.getElementById('prepareSendGmail').onclick = function() {
            if (dailySentCount >= dailyLimit) { alert('Daily limit reached. Send more tomorrow.'); return; }
            var ready = leadsCache.filter(function(l) { return l.status === 'ready' && l.email; });
            if (!ready.length) return;
            var rows = [['Business Name', 'Email Address', 'Email Subject', 'Email Body', 'Status']];
            ready.forEach(function(l) {
                rows.push([l.business_name || '', l.email || '', l.email_subject || '', l.email_body || '', '']);
            });
            var csv = rows.map(function(row) {
                return row.map(csvEscape).join(',');
            }).join('\r\n');
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'leads_gmail.csv';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
            var pre = document.getElementById('gmailScriptPre');
            if (pre) { pre.textContent = GMAIL_APPS_SCRIPT; }
            var modal = document.getElementById('gmailScriptModal');
            if (modal) modal.classList.remove('hidden');
        };
        document.getElementById('copyScriptBtn').onclick = function() {
            navigator.clipboard.writeText(GMAIL_APPS_SCRIPT).then(function() { alert('Script copied to clipboard. Paste into Apps Script and run sendEmails.'); }).catch(function() { alert('Copy failed. Select and copy the script manually.'); });
        };
        document.getElementById('closeScriptModalBtn').onclick = function() {
            document.getElementById('gmailScriptModal').classList.add('hidden');
        };
        document.getElementById('gmailScriptModal').onclick = function(e) {
            if (e.target && e.target.id === 'gmailScriptModal') e.target.classList.add('hidden');
        };

        document.getElementById('exportCsv').onclick = async function() {
            var trade = getSelectedTrade();
            var suburb = document.getElementById('suburb').value;
            var url = API_BASE + '/api/leads/export?';
            if (trade) url += 'trade_type=' + encodeURIComponent(trade) + '&';
            if (suburb) url += 'suburb=' + encodeURIComponent(suburb);
            const r = await fetch(url, { headers: getHeaders() });
            if (!r.ok) return;
            const blob = await r.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'leads_export.csv';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
        };

        document.getElementById('refreshLeads').onclick = function() { loadLeads(); };

        let lastLogId = 0;
        async function pollLog() {
            try {
                const r = await fetch(API_BASE + '/api/leads/autopilot/log?since_id=' + lastLogId + '&limit=80', { headers: getHeaders() });
                if (!r.ok) return;
                const data = await r.json();
                const log = data.log || [];
                const panel = document.getElementById('logPanel');
                log.forEach(entry => {
                    if (entry.id > lastLogId) lastLogId = entry.id;
                    const time = entry.created_at ? new Date(entry.created_at).toLocaleTimeString() : '';
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = '<span class="log-time">' + time + '</span><span class="log-phase">[' + escapeHtml(entry.phase || '') + ']</span> ' + escapeHtml(entry.message || '');
                    panel.appendChild(div);
                });
                panel.scrollTop = panel.scrollHeight;
            } catch (_) {}
        }
        function startLogPolling() {
            pollLog();
            setInterval(pollLog, 2500);
        }
    </script>
</body>
</html>

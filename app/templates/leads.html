<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotionMade – Leads</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #0f172a; font-size: 15px; line-height: 1.6; -webkit-font-smoothing: antialiased; }
        .hidden { display: none !important; }

        /* Header */
        header { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 16px 24px; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 40; backdrop-filter: blur(8px); background: rgba(255,255,255,0.92); }
        .logo { font-size: 17px; font-weight: 700; color: #1e40af; letter-spacing: -0.02em; }
        .logo-dot { color: #3b82f6; }
        .header-subtitle { font-size: 13px; color: #94a3b8; font-weight: 400; }

        .container { max-width: 1080px; margin: 0 auto; padding: 28px 24px 48px; }

        /* Auth */
        .auth-section { max-width: 400px; margin: 80px auto; background: #fff; padding: 40px 36px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.04); text-align: center; }
        .auth-section h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; color: #0f172a; }
        .auth-section .auth-hint { font-size: 13px; color: #94a3b8; margin-bottom: 20px; }
        .auth-section input { padding: 11px 14px; border: 1px solid #e2e8f0; border-radius: 10px; width: 100%; font-size: 14px; background: #f8fafc; transition: border-color 0.15s, box-shadow 0.15s; font-family: inherit; }
        .auth-section input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); background: #fff; }
        .auth-section button { padding: 11px 24px; background: #1e40af; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; width: 100%; margin-top: 12px; transition: background 0.15s, transform 0.1s; font-family: inherit; }
        .auth-section button:hover { background: #1e3a8a; }
        .auth-section button:active { transform: scale(0.98); }
        .error { color: #dc2626; margin-top: 12px; font-size: 13px; font-weight: 500; }

        /* Activity banner */
        .activity-banner { border-radius: 10px; padding: 12px 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .activity-banner.idle { background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d; }
        .activity-banner.busy { background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8; }
        .activity-banner.success { background: #f0fdf4; border: 1px solid #86efac; color: #15803d; }
        .pulse { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .idle .pulse { background: #22c55e; }
        .busy .pulse { background: #3b82f6; animation: pulse 1.4s ease-in-out infinite; }
        .success .pulse { background: #22c55e; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.7); } }
        .progress-track { height: 4px; background: #e2e8f0; border-radius: 2px; width: 100%; margin-top: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #6366f1); border-radius: 2px; transition: width 0.5s ease; }

        /* Daily batch hero */
        .daily-batch-wrap { background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 50%, #3b82f6 100%); border-radius: 16px; padding: 32px 28px; margin-bottom: 24px; text-align: center; color: white; position: relative; overflow: hidden; }
        .daily-batch-wrap::before { content: ''; position: absolute; top: -40%; right: -20%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%); border-radius: 50%; }
        .daily-batch-wrap h2 { font-size: 20px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.02em; position: relative; }
        .daily-batch-wrap p { font-size: 14px; opacity: 0.75; margin-bottom: 20px; position: relative; }
        .btn-daily-batch { padding: 14px 44px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; border: none; background: white; color: #1e3a8a; transition: all 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.12); font-family: inherit; letter-spacing: -0.01em; }
        .btn-daily-batch:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn-daily-batch:active:not(:disabled) { transform: translateY(0); }
        .btn-daily-batch:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Card base */
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 20px 22px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }

        /* Controls */
        .controls { display: flex; flex-wrap: wrap; gap: 18px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        .control-group label { font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .control-group input, .control-group select { padding: 9px 12px; border: 1px solid #e2e8f0; border-radius: 8px; min-width: 120px; font-size: 14px; background: #f8fafc; transition: border-color 0.15s, box-shadow 0.15s; font-family: inherit; color: #0f172a; }
        .control-group input:focus, .control-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.08); background: #fff; }
        .control-group input[type="number"] { width: 76px; }

        /* Trade buttons */
        .trade-group { margin-bottom: 10px; }
        .trade-group:last-child { margin-bottom: 0; }
        .trade-group-label { font-size: 10px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px; }
        .trade-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
        .btn-trade { padding: 7px 14px; border-radius: 8px; font-size: 13px; cursor: pointer; background: #f8fafc; color: #475569; border: 1.5px solid #e2e8f0; font-weight: 500; transition: all 0.15s; font-family: inherit; }
        .btn-trade:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .btn-trade.selected { background: #1e40af; color: white; border-color: #1e40af; box-shadow: 0 1px 4px rgba(30,64,175,0.3); }
        .btn-trade:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-trade.professional { border-color: #ddd6fe; }
        .btn-trade.professional:hover { background: #f5f3ff; border-color: #c4b5fd; }
        .btn-trade.professional.selected { background: #6d28d9; color: white; border-color: #6d28d9; box-shadow: 0 1px 4px rgba(109,40,217,0.3); }

        /* Action buttons */
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-left: auto; }
        .btn-run { padding: 9px 18px; border-radius: 9px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; color: white; white-space: nowrap; transition: all 0.15s; font-family: inherit; }
        .btn-run:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .btn-run:active:not(:disabled) { transform: translateY(0); }
        .btn-run:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-run.primary { background: #1e40af; }
        .btn-run.primary:hover:not(:disabled) { background: #1e3a8a; }
        .btn-run-all-trades { background: #7c3aed; }
        .btn-run-all-trades:hover:not(:disabled) { background: #6d28d9; }
        .btn-run-all-pro { background: #6d28d9; }
        .btn-run-all-pro:hover:not(:disabled) { background: #5b21b6; }

        /* Log */
        .log-section { margin-bottom: 20px; }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .log-header span { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .log-header a { color: #3b82f6; cursor: pointer; text-decoration: none; font-size: 12px; font-weight: 500; }
        .log-header a:hover { color: #1d4ed8; }
        .log-panel { background: #0f172a; color: #cbd5e1; border-radius: 10px; padding: 14px 16px; font-family: 'SF Mono', 'Fira Code', ui-monospace, monospace; font-size: 11.5px; max-height: 180px; overflow-y: auto; line-height: 1.7; scrollbar-width: thin; scrollbar-color: #334155 #0f172a; }
        .log-panel::-webkit-scrollbar { width: 6px; }
        .log-panel::-webkit-scrollbar-track { background: #0f172a; }
        .log-panel::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .log-panel .log-entry { margin-bottom: 2px; }
        .log-panel .log-phase { color: #7dd3fc; font-weight: 500; }
        .log-panel .log-time { color: #64748b; margin-right: 8px; font-size: 10.5px; }

        /* Stats */
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px 18px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .stat-card .stat-label { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -0.03em; line-height: 1.2; }
        .stat-card .stat-value.ready { color: #059669; }
        .stat-card .stat-value.sent { color: #2563eb; }
        .stat-card .stat-value.sent.at-limit { color: #dc2626; }
        .stat-card .stat-value.total { color: #475569; }
        .stat-card .stat-detail { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .stats-breakdown { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
        .stats-breakdown .trade-stat { padding: 5px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 12px; color: #64748b; font-weight: 500; }
        .stats-actions { display: flex; gap: 8px; align-items: center; }
        .limit-wrap { position: relative; }
        .btn-limit-gear { background: none; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; padding: 6px 10px; color: #64748b; font-size: 14px; transition: all 0.15s; }
        .btn-limit-gear:hover { background: #f1f5f9; color: #475569; }
        .limit-dropdown { position: absolute; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); padding: 4px; z-index: 50; min-width: 110px; right: 0; top: 100%; margin-top: 6px; }
        .limit-dropdown button { display: block; width: 100%; padding: 8px 14px; text-align: left; border: none; background: none; cursor: pointer; font-size: 13px; border-radius: 6px; font-family: inherit; color: #475569; transition: background 0.1s; }
        .limit-dropdown button:hover { background: #f1f5f9; }
        .btn-refresh { padding: 6px 14px; border-radius: 8px; font-size: 12px; cursor: pointer; background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; font-weight: 500; transition: all 0.15s; font-family: inherit; }
        .btn-refresh:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .daily-limit-warning { font-size: 13px; color: #d97706; margin-bottom: 12px; padding: 10px 16px; background: #fffbeb; border: 1px solid #fde68a; border-radius: 10px; font-weight: 500; }
        .daily-limit-block { font-size: 13px; color: #dc2626; margin-bottom: 12px; font-weight: 500; padding: 10px 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px; }
        .daily-limit-reset-timer { margin-left: 4px; color: #94a3b8; font-weight: 400; }

        /* Pipeline toolbar */
        .pipeline-toolbar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .pipeline-search { padding: 9px 14px; border: 1px solid #e2e8f0; border-radius: 9px; font-size: 13px; min-width: 200px; flex: 1; max-width: 340px; background: #fff; font-family: inherit; color: #0f172a; transition: border-color 0.15s, box-shadow 0.15s; }
        .pipeline-search::placeholder { color: #94a3b8; }
        .pipeline-search:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.08); }
        .pipeline-filter-select { padding: 9px 12px; border: 1px solid #e2e8f0; border-radius: 9px; font-size: 13px; background: #fff; font-family: inherit; color: #0f172a; cursor: pointer; }
        .pipeline-filter-select:focus { outline: none; border-color: #3b82f6; }

        /* Pipeline sections */
        .pipeline-section { margin-bottom: 20px; border-radius: 14px; overflow: hidden; border: 1px solid #e2e8f0; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .pipeline-section.ready-section { border-color: #a7f3d0; }
        .pipeline-section.sent-section { border-color: #e2e8f0; }
        .pipeline-section-header { padding: 14px 20px; font-weight: 600; font-size: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .pipeline-section.ready-section .pipeline-section-header { background: linear-gradient(135deg, #ecfdf5, #d1fae5); color: #065f46; }
        .pipeline-section.sent-section .pipeline-section-header { background: #f8fafc; color: #475569; cursor: pointer; transition: background 0.15s; }
        .pipeline-section.sent-section .pipeline-section-header:hover { background: #f1f5f9; }
        .pipeline-section-header summary { list-style: none; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .pipeline-section-header summary::-webkit-details-marker { display: none; }

        /* Ready toolbar */
        .ready-toolbar { display: flex; align-items: center; gap: 10px; padding: 10px 20px; background: #f0fdf4; border-bottom: 1px solid #d1fae5; flex-wrap: wrap; }
        .ready-toolbar label { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; color: #065f46; cursor: pointer; user-select: none; }
        .ready-toolbar input[type="checkbox"] { width: 16px; height: 16px; accent-color: #059669; cursor: pointer; }
        .ready-filter-select { padding: 6px 10px; border: 1px solid #a7f3d0; border-radius: 7px; font-size: 12px; background: #fff; font-family: inherit; color: #065f46; cursor: pointer; }
        .ready-filter-select:focus { outline: none; border-color: #059669; }
        .ready-selected-count { font-size: 12px; color: #047857; font-weight: 500; margin-left: auto; }

        .send-all-wrap { display: flex; align-items: center; gap: 10px; }
        .pipeline-table .cb-col { width: 36px; text-align: center; }
        .pipeline-table .cb-col input[type="checkbox"] { width: 15px; height: 15px; accent-color: #059669; cursor: pointer; }
        .btn-send-all { padding: 10px 22px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; border: none; background: #059669; color: white; transition: all 0.15s; font-family: inherit; }
        .btn-send-all:hover:not(:disabled) { background: #047857; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(5,150,105,0.3); }
        .btn-send-all:active:not(:disabled) { transform: translateY(0); }
        .btn-send-all:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .send-progress-bar-wrap { height: 4px; background: #e2e8f0; border-radius: 2px; width: 160px; overflow: hidden; }
        .send-progress-bar-fill { height: 100%; background: #2563EB; border-radius: 2px; transition: width 0.2s; }

        /* Tables */
        .pipeline-table-wrap { overflow-x: auto; }
        table.pipeline-table { width: 100%; border-collapse: collapse; }
        .pipeline-table th, .pipeline-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #f1f5f9; vertical-align: middle; font-size: 13px; }
        .pipeline-table th { font-weight: 600; font-size: 10px; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.06em; background: #fafbfc; }
        .pipeline-section.ready-section .pipeline-table tbody tr { background: #fff; transition: background 0.1s; }
        .pipeline-section.ready-section .pipeline-table tbody tr:hover { background: #f0fdf4; }
        .pipeline-section.sent-section .pipeline-table tbody tr { background: #fff; color: #94a3b8; transition: background 0.1s; }
        .pipeline-section.sent-section .pipeline-table tbody tr:hover { background: #f8fafc; }
        .pipeline-table .subject-preview { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 12px; color: #64748b; }
        .pipeline-table .sent-at { font-size: 12px; color: #94a3b8; }

        /* Badges */
        .badge-trade { font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.04em; display: inline-block; }
        .badge-bond { background: #dbeafe; color: #1e40af; }
        .badge-house { background: #fef3c7; color: #92400e; }
        .badge-plumber { background: #ede9fe; color: #5b21b6; }
        .badge-dentist { background: #fce7f3; color: #9d174d; }
        .badge-physio { background: #d1fae5; color: #065f46; }
        .badge-accountant { background: #e0e7ff; color: #3730a3; }
        .badge-vet { background: #ffe4e6; color: #9f1239; }

        .score-pill { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .score-high { background: #dcfce7; color: #166534; }
        .score-mid { background: #fef3c7; color: #92400e; }
        .score-low { background: #fee2e2; color: #991b1b; }

        /* Small buttons */
        .btn-sm { padding: 5px 11px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #e2e8f0; background: #fff; color: #475569; transition: all 0.12s; font-family: inherit; font-weight: 500; }
        .btn-sm:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .btn-sm:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-skip { color: #ef4444; border-color: #fecaca; background: #fff; }
        .btn-skip:hover { background: #fef2f2; border-color: #fca5a5; }
        .btn-gmail { background: #dc2626; color: white; border-color: #dc2626; }
        .btn-gmail:hover:not(:disabled) { background: #b91c1c; }
        .btn-gmail:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Expand row */
        .expand-row-pipeline { background: #fafbfc; }
        .expand-row-pipeline td { padding: 20px 16px; border-bottom: 1px solid #e2e8f0; vertical-align: top; font-size: 13px; }
        .expand-row-pipeline .label { font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 4px; }
        .expand-row-pipeline .value { white-space: pre-wrap; word-break: break-word; color: #334155; }
        .expand-row-pipeline .value.body { background: #fff; padding: 16px; border-radius: 10px; border: 1px solid #e2e8f0; line-height: 1.7; font-size: 13px; }

        /* Pagination */
        .pagination { display: flex; gap: 6px; align-items: center; justify-content: center; padding: 14px; font-size: 13px; }
        .pagination button { padding: 7px 14px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 13px; font-family: inherit; color: #475569; transition: all 0.12s; }
        .pagination button:hover:not(:disabled) { background: #f1f5f9; border-color: #cbd5e1; }
        .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination .current { font-weight: 600; color: #1e40af; }

        /* No email section */
        .no-email-section { margin-top: 8px; border: 1px solid #e2e8f0; border-radius: 10px; background: #fafbfc; }
        .no-email-section summary { padding: 12px 16px; cursor: pointer; font-size: 13px; color: #94a3b8; font-weight: 500; }
        .no-email-section summary:hover { color: #64748b; }

        /* Footer */
        .footer-actions { text-align: center; padding: 24px 0 8px; }
        .btn-export { padding: 8px 18px; font-size: 13px; border-radius: 8px; cursor: pointer; background: #fff; color: #64748b; border: 1px solid #e2e8f0; font-family: inherit; font-weight: 500; transition: all 0.15s; }
        .btn-export:hover { background: #f1f5f9; border-color: #cbd5e1; color: #475569; }
        .btn-backup-csv { padding: 6px 14px; font-size: 12px; border-radius: 8px; cursor: pointer; background: #fff; color: #64748b; border: 1px solid #e2e8f0; font-family: inherit; font-weight: 500; transition: all 0.15s; }
        .btn-backup-csv:hover { background: #f1f5f9; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: #fff; border-radius: 16px; max-width: 560px; width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .modal-header { padding: 18px 22px; border-bottom: 1px solid #f1f5f9; font-weight: 600; font-size: 16px; color: #0f172a; }
        .modal-body { padding: 22px; overflow-y: auto; font-size: 14px; line-height: 1.7; color: #475569; }
        .modal-body pre { background: #0f172a; color: #e2e8f0; padding: 16px; border-radius: 10px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; margin: 14px 0; text-align: left; }
        .modal-footer { padding: 16px 22px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px; justify-content: flex-end; }
        .btn-copy-script { padding: 9px 18px; border-radius: 9px; font-size: 13px; cursor: pointer; background: #1e40af; color: white; border: none; font-family: inherit; font-weight: 600; transition: background 0.15s; }
        .btn-copy-script:hover { background: #1e3a8a; }
        .btn-modal-close { padding: 9px 18px; border-radius: 9px; font-size: 13px; cursor: pointer; background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; font-family: inherit; font-weight: 500; transition: all 0.15s; }
        .btn-modal-close:hover { background: #f1f5f9; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 16px 14px 40px; }
            .controls { gap: 12px; }
            .daily-batch-wrap { padding: 24px 18px; }
            .btn-daily-batch { padding: 12px 28px; font-size: 15px; }
            .stats-bar { grid-template-columns: 1fr; gap: 10px; }
            .stat-card .stat-value { font-size: 22px; }
            .pipeline-table th, .pipeline-table td { padding: 10px 12px; font-size: 12px; }
            .action-buttons { margin-left: 0; width: 100%; }
            .auth-section { margin: 40px auto; padding: 28px 22px; }
            header { padding: 12px 16px; }
        }
        @media (max-width: 480px) {
            .stat-card { padding: 12px 14px; }
            .btn-run { padding: 8px 14px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <header>
        <span class="logo">Motion<span class="logo-dot">Made</span></span>
        <span class="header-subtitle">Find local businesses, write personalised emails, and send them automatically.</span>
    </header>
    <div class="container">
        <div class="auth-section" id="authSection">
            <h3>Welcome back</h3>
            <p class="auth-hint">Enter your admin token to continue</p>
            <input type="password" id="adminToken" placeholder="Paste token here..." />
            <button id="loginBtn">Sign in</button>
            <div id="authError" class="error"></div>
        </div>

        <div id="mainContent" class="hidden">
            <!-- Activity banner -->
            <div id="activityBanner" class="activity-banner idle">
                <span class="pulse"></span>
                <span id="activityText">Ready.</span>
            </div>
            <div id="progressTrack" class="progress-track hidden"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>

            <!-- Daily batch hero -->
            <div class="daily-batch-wrap">
                <h2>Daily Lead Generation</h2>
                <p>Discover, audit, and write emails across all 7 trades in one click.</p>
                <button type="button" id="dailyBatchBtn" class="btn-daily-batch">Run Daily Batch</button>
            </div>

            <!-- Controls -->
            <div class="card controls">
                <div class="control-group">
                    <label>Trade</label>
                    <div>
                        <div class="trade-group">
                            <div class="trade-group-label">Trades</div>
                            <div class="trade-buttons">
                                <button type="button" class="btn-trade selected" data-trade="Bond Cleaning">Bond Cleaning</button>
                                <button type="button" class="btn-trade" data-trade="House Cleaning">House Cleaning</button>
                                <button type="button" class="btn-trade" data-trade="Plumber">Plumber</button>
                            </div>
                        </div>
                        <div class="trade-group">
                            <div class="trade-group-label">Professional Services</div>
                            <div class="trade-buttons">
                                <button type="button" class="btn-trade professional" data-trade="Dentist">Dentist</button>
                                <button type="button" class="btn-trade professional" data-trade="Physiotherapist">Physio</button>
                                <button type="button" class="btn-trade professional" data-trade="Accountant">Accountant</button>
                                <button type="button" class="btn-trade professional" data-trade="Vet">Vet</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label>City</label>
                    <select id="city">
                        <option value="Brisbane" selected>Brisbane</option>
                        <option value="Gold Coast">Gold Coast</option>
                        <option value="Sunshine Coast">Sunshine Coast</option>
                        <option value="Sydney">Sydney</option>
                        <option value="Melbourne">Melbourne</option>
                        <option value="Perth">Perth</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Target</label>
                    <input type="number" id="targetCount" min="5" max="50" value="10" />
                </div>
                <div class="action-buttons">
                    <button type="button" id="runSingle" class="btn-run primary action-btn">Find Leads</button>
                    <button type="button" id="runAllTrades" class="btn-run btn-run-all-trades action-btn">All Trades</button>
                    <button type="button" id="runAllPro" class="btn-run btn-run-all-pro action-btn">All Professional</button>
                </div>
            </div>

            <!-- Log -->
            <div class="log-section">
                <div class="log-header"><span>Activity Log</span><a id="clearLog" href="#">Clear</a></div>
                <div class="log-panel" id="logPanel"></div>
            </div>

            <!-- Stats -->
            <div id="statsBar" class="stats-bar hidden">
                <div class="stat-card">
                    <div class="stat-label">Ready to send</div>
                    <div class="stat-value ready" id="statReady">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sent today</div>
                    <div class="stat-value sent" id="statSentToday">0</div>
                    <div class="stat-detail">of <span id="statLimit">20</span> daily limit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total leads</div>
                    <div class="stat-value total" id="statTotalAll">0</div>
                    <div class="stat-detail stats-actions">
                        <div class="limit-wrap">
                            <button type="button" id="dailyLimitGear" class="btn-limit-gear" title="Change daily limit">&#9881;</button>
                            <div id="limitDropdown" class="limit-dropdown hidden">
                                <button type="button" data-limit="10">10 / day</button>
                                <button type="button" data-limit="15">15 / day</button>
                                <button type="button" data-limit="20">20 / day</button>
                                <button type="button" data-limit="30">30 / day</button>
                                <button type="button" data-limit="50">50 / day</button>
                            </div>
                        </div>
                        <button type="button" id="refreshLeads" class="btn-refresh">Refresh</button>
                    </div>
                </div>
            </div>
            <div id="statsBreakdown" class="stats-breakdown"></div>
            <div id="dailyLimitWarning" class="daily-limit-warning hidden">You're approaching today's send limit.</div>
            <div id="dailyLimitBlock" class="daily-limit-block hidden">Daily limit reached. Resets at midnight AEST. <span id="dailyLimitResetTimer" class="daily-limit-reset-timer"></span></div>

            <!-- Pipeline toolbar -->
            <div class="pipeline-toolbar">
                <input type="text" id="pipelineSearch" class="pipeline-search" placeholder="Search businesses..." />
                <select id="pipelineTradeFilter" class="pipeline-filter-select">
                    <option value="">All trades</option>
                    <option value="Bond Cleaning">Bond Cleaning</option>
                    <option value="House Cleaning">House Cleaning</option>
                    <option value="Plumber">Plumber</option>
                    <option value="Dentist">Dentist</option>
                    <option value="Physiotherapist">Physiotherapist</option>
                    <option value="Accountant">Accountant</option>
                    <option value="Vet">Vet</option>
                </select>
            </div>

            <!-- Ready section -->
            <div id="pipelineReadySection" class="pipeline-section ready-section hidden">
                <div class="pipeline-section-header">
                    <span>Ready to Send (<span id="readyCount">0</span>)</span>
                    <div class="send-all-wrap">
                        <button type="button" id="sendAllNowBtn" class="btn-send-all action-btn hidden">Send 0 Selected Emails Now</button>
                        <button type="button" id="prepareSendGmail" class="btn-backup-csv hidden">CSV backup</button>
                    </div>
                </div>
                <div class="ready-toolbar">
                    <label><input type="checkbox" id="selectAllReady" /> Select all</label>
                    <select id="readyTradeFilter" class="ready-filter-select">
                        <option value="">All trades</option>
                        <option value="Bond Cleaning">Bond Cleaning</option>
                        <option value="House Cleaning">House Cleaning</option>
                        <option value="Plumber">Plumber</option>
                        <option value="Dentist">Dentist</option>
                        <option value="Physiotherapist">Physiotherapist</option>
                        <option value="Accountant">Accountant</option>
                        <option value="Vet">Vet</option>
                    </select>
                    <span id="readySelectedCount" class="ready-selected-count"></span>
                </div>
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table" id="leadsReadyTable">
                        <thead><tr><th class="cb-col"></th><th>Business</th><th>Trade</th><th>Score</th><th>Subject</th><th style="width:140px;"></th></tr></thead>
                        <tbody id="leadsReadyBody"></tbody>
                    </table>
                </div>
                <div id="readyPagination" class="pagination hidden"></div>
            </div>

            <!-- Sent section -->
            <details id="pipelineSentSection" class="pipeline-section sent-section hidden">
                <summary class="pipeline-section-header"><span>Sent (<span id="sentCount">0</span>)</span></summary>
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table">
                        <thead><tr><th>Business</th><th>Trade</th><th>Subject</th><th>When</th></tr></thead>
                        <tbody id="leadsSentBody"></tbody>
                    </table>
                </div>
                <div id="sentPagination" class="pagination hidden"></div>
            </details>

            <details id="noEmailSection" class="no-email-section hidden">
                <summary id="noEmailSummary">0 leads without email</summary>
                <div id="noEmailList" style="padding:10px 16px 14px;font-size:13px;color:#94a3b8;line-height:1.6;"></div>
            </details>

            <div class="footer-actions">
                <button type="button" id="exportCsv" class="btn-export">Export CSV</button>
            </div>
        </div>
    </div>

    <div id="gmailScriptModal" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-header">Send via Gmail</div>
            <div class="modal-body">
                <p><strong>1.</strong> CSV downloaded. Open Google Sheets, then File, Import, Upload <code>leads_gmail.csv</code>.</p>
                <p><strong>2.</strong> In Sheets: Extensions, Apps Script. Paste the script below, save, run <code>sendEmails</code>.</p>
                <pre id="gmailScriptPre"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" id="copyScriptBtn" class="btn-copy-script">Copy script</button>
                <button type="button" id="closeScriptModalBtn" class="btn-modal-close">Close</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        var API = window.location.origin;
        var adminToken = '';
        var leadsCache = [];
        var dailySentCount = 0;
        var dailyLimit = 20;
        var operationRunning = false;
        var lastLogId = 0;
        var logAutoScroll = true;
        var readyPage = 1;
        var sentPage = 1;
        var PAGE_SIZE = 25;
        var TRADES = ['Bond Cleaning', 'House Cleaning', 'Plumber'];
        var PRO_TRADES = ['Dentist', 'Physiotherapist', 'Accountant', 'Vet'];
        var ALL_TRADES = TRADES.concat(PRO_TRADES);
        var dailyLimitResetTimerInterval = null;
        var selectedLeadIds = new Set();

        function h() { return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminToken }; }
        function check401(r) { if (r.status === 401) { logout(); return true; } return false; }
        function esc(s) { if (s == null) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function $(id) { return document.getElementById(id); }

        function getSelectedTrade() { var s = document.querySelector('.btn-trade.selected'); return s ? s.getAttribute('data-trade') : 'Bond Cleaning'; }
        function getCity() { return ($('city') && $('city').value) || 'Brisbane'; }
        function getTarget() { return Math.min(50, Math.max(5, parseInt(($('targetCount') && $('targetCount').value) || '10', 10) || 10)); }

        document.querySelectorAll('.btn-trade').forEach(function(btn) {
            btn.onclick = function() {
                if (operationRunning) return;
                document.querySelectorAll('.btn-trade').forEach(function(b) { b.classList.remove('selected'); });
                this.classList.add('selected');
            };
        });

        function setOperationState(running) {
            operationRunning = running;
            document.querySelectorAll('.action-btn').forEach(function(b) { b.disabled = running; if (running) b.title = 'Wait for current operation to finish'; else b.title = ''; });
            $('dailyBatchBtn').disabled = running;
            document.querySelectorAll('.btn-trade').forEach(function(b) { b.disabled = running; });
        }

        function setBanner(type, text) {
            var b = $('activityBanner');
            b.className = 'activity-banner ' + type;
            $('activityText').textContent = text;
        }
        function setProgress(pct) {
            var track = $('progressTrack');
            if (pct < 0) { track.classList.add('hidden'); return; }
            track.classList.remove('hidden');
            $('progressFill').style.width = Math.min(100, pct) + '%';
        }
        function flashSuccess(text) {
            setBanner('success', text);
            setProgress(-1);
            setTimeout(function() { if (!operationRunning) updateIdleBanner(); }, 5000);
        }
        function updateIdleBanner() {
            var ready = leadsCache.filter(function(l) { return l.status === 'ready' && l.email; }).length;
            if (ready > 0) setBanner('idle', ready + ' emails queued and ready to send.');
            else setBanner('idle', 'All caught up. Run Daily Batch to find more leads.');
            setProgress(-1);
        }

        /* Limit dropdown */
        function getDailyLimit() { try { var v = localStorage.getItem('leads_daily_limit'); if (v) { var n = parseInt(v, 10); if ([10,15,20,30,50].indexOf(n) >= 0) return n; } } catch (e) {} return 20; }
        $('dailyLimitGear').onclick = function(e) { e.stopPropagation(); $('limitDropdown').classList.toggle('hidden'); };
        $('limitDropdown').onclick = function(e) { e.stopPropagation(); };
        $('limitDropdown').querySelectorAll('button').forEach(function(btn) {
            btn.onclick = function() { try { localStorage.setItem('leads_daily_limit', this.getAttribute('data-limit')); } catch (z) {} $('limitDropdown').classList.add('hidden'); loadStats(); };
        });
        document.addEventListener('click', function() { $('limitDropdown').classList.add('hidden'); });

        /* Timer */
        function getMsBrisbane() { var now = new Date(); var off = 10*3600000; var day = 86400000; var start = Math.floor((now.getTime()+off)/day)*day - off; return Math.max(0, start+day-now.getTime()); }
        function fmtReset(ms) { if (ms<=0) return '(resets now)'; var s=Math.floor(ms/1000); var m=Math.floor(s/60); s%=60; var hr=Math.floor(m/60); m%=60; return hr>0?hr+'h '+m+'m':m+'m '+s+'s'; }
        function updateResetTimer() { var el=$('dailyLimitResetTimer'); if(!el)return; if(dailySentCount<dailyLimit){if(dailyLimitResetTimerInterval){clearInterval(dailyLimitResetTimerInterval);dailyLimitResetTimerInterval=null;}el.textContent='';return;} el.textContent=fmtReset(getMsBrisbane()); if(!dailyLimitResetTimerInterval) dailyLimitResetTimerInterval=setInterval(updateResetTimer,1000); }

        /* Stats */
        async function loadStats() {
            dailyLimit = getDailyLimit();
            try {
                var r = await fetch(API + '/api/leads/pipeline-stats', { headers: h() });
                if (check401(r)) return;
                if (!r.ok) return;
                var d = await r.json();
                dailySentCount = d.total_sent_today || 0;
                dailyLimit = d.limit || dailyLimit;
                $('statReady').textContent = d.total_ready || 0;
                $('statSentToday').textContent = dailySentCount;
                $('statSentToday').className = 'stat-value sent' + (dailySentCount >= dailyLimit ? ' at-limit' : '');
                $('statLimit').textContent = dailyLimit;
                $('statTotalAll').textContent = d.total_all || 0;
                var bd = $('statsBreakdown');
                bd.innerHTML = (d.trades || []).map(function(t) { return '<span class="trade-stat">' + esc(t.trade) + ': ' + t.ready + ' ready, ' + t.sent_today + ' sent</span>'; }).join('');
                $('statsBar').classList.remove('hidden');
            } catch (e) {}
            var warn = $('dailyLimitWarning'); var block = $('dailyLimitBlock');
            if (warn) { if (dailySentCount >= Math.max(1, dailyLimit - 5) && dailySentCount < dailyLimit) warn.classList.remove('hidden'); else warn.classList.add('hidden'); }
            if (block) { if (dailySentCount >= dailyLimit) block.classList.remove('hidden'); else block.classList.add('hidden'); }
            updateResetTimer();
        }

        /* Load leads (ALL trades, no trade filter — filter is client-side) */
        async function loadLeads() {
            try {
                var r = await fetch(API + '/api/leads', { headers: h() });
                if (check401(r)) return;
                if (!r.ok) return;
                var d = await r.json();
                leadsCache = d.leads || [];
            } catch (e) {}
            renderLeads();
            loadStats();
            if (!operationRunning) updateIdleBanner();
        }

        function tradeBadge(t) {
            var cls = 'badge-trade ';
            var tl = (t||'').toLowerCase();
            if (tl.indexOf('bond') >= 0) cls += 'badge-bond';
            else if (tl.indexOf('house') >= 0) cls += 'badge-house';
            else if (tl.indexOf('plumb') >= 0) cls += 'badge-plumber';
            else if (tl.indexOf('dentist') >= 0 || tl.indexOf('dental') >= 0) cls += 'badge-dentist';
            else if (tl.indexOf('physio') >= 0) cls += 'badge-physio';
            else if (tl.indexOf('accountant') >= 0 || tl.indexOf('accounting') >= 0) cls += 'badge-accountant';
            else if (tl.indexOf('vet') >= 0) cls += 'badge-vet';
            else cls += 'badge-plumber';
            return '<span class="' + cls + '">' + esc(t) + '</span>';
        }
        function scorePill(s) {
            if (s == null) return '<span style="color:#cbd5e1;">—</span>';
            var cls = s >= 7 ? 'score-high' : s >= 4 ? 'score-mid' : 'score-low';
            return '<span class="score-pill ' + cls + '">' + s + '</span>';
        }
        function fmtSent(u) { if (!u) return 'Sent'; var d = new Date(u); if (isNaN(d)) return 'Sent'; var now = new Date(); var diff = Math.floor((now-d)/60000); if (diff < 1) return 'Just now'; if (diff < 60) return diff + 'm ago'; var dh = Math.floor(diff/60); if (dh < 24) return dh + 'h ago'; return d.toLocaleDateString(); }

        function getFilteredLeads(statusList) {
            var search = ($('pipelineSearch') && $('pipelineSearch').value || '').toLowerCase();
            var tradeFilter = ($('pipelineTradeFilter') && $('pipelineTradeFilter').value) || '';
            return leadsCache.filter(function(l) {
                if (statusList.indexOf(l.status) < 0) return false;
                if (tradeFilter && l.trade_type !== tradeFilter) return false;
                if (search && (l.business_name || '').toLowerCase().indexOf(search) < 0 && (l.trade_type || '').toLowerCase().indexOf(search) < 0) return false;
                return true;
            });
        }

        function getReadyLeads() {
            var search = ($('pipelineSearch') && $('pipelineSearch').value || '').toLowerCase();
            var tradeFilter = ($('pipelineTradeFilter') && $('pipelineTradeFilter').value) || '';
            var readyTradeFilter = ($('readyTradeFilter') && $('readyTradeFilter').value) || '';
            return leadsCache.filter(function(l) {
                if (l.status !== 'ready') return false;
                if (!(l.email || '').trim()) return false;
                if (tradeFilter && l.trade_type !== tradeFilter) return false;
                if (readyTradeFilter && l.trade_type !== readyTradeFilter) return false;
                if (search && (l.business_name || '').toLowerCase().indexOf(search) < 0 && (l.trade_type || '').toLowerCase().indexOf(search) < 0) return false;
                return true;
            }).sort(function(a, b) { return (b.audit_score || 0) - (a.audit_score || 0); });
        }

        function pruneSelectedIds(visibleLeads) {
            var visibleIds = new Set(visibleLeads.map(function(l) { return String(l.id); }));
            selectedLeadIds.forEach(function(id) { if (!visibleIds.has(id)) selectedLeadIds.delete(id); });
        }

        function renderLeads() {
            var readyLeads = getReadyLeads();
            pruneSelectedIds(readyLeads);
            var sentLeads = getFilteredLeads(['emailed']);
            var noEmail = leadsCache.filter(function(l) { return l.status !== 'skip' && l.status !== 'emailed' && !(l.email || '').trim(); });

            $('readyCount').textContent = readyLeads.length;
            $('sentCount').textContent = sentLeads.length;

            var readySection = $('pipelineReadySection');
            var sentSection = $('pipelineSentSection');
            if (readyLeads.length > 0) readySection.classList.remove('hidden'); else readySection.classList.add('hidden');
            if (sentLeads.length > 0) sentSection.classList.remove('hidden'); else sentSection.classList.add('hidden');

            renderReadyTable(readyLeads);
            renderSentTable(sentLeads);
            updateSendBtn();

            var noSec = $('noEmailSection');
            var noSum = $('noEmailSummary');
            if (noEmail.length) { noSec.classList.remove('hidden'); noSum.textContent = noEmail.length + ' leads without email'; $('noEmailList').textContent = noEmail.map(function(l) { return l.business_name || '?'; }).join(', '); }
            else noSec.classList.add('hidden');
        }

        function renderReadyTable(leads) {
            var totalPages = Math.max(1, Math.ceil(leads.length / PAGE_SIZE));
            if (readyPage > totalPages) readyPage = totalPages;
            var start = (readyPage - 1) * PAGE_SIZE;
            var page = leads.slice(start, start + PAGE_SIZE);
            var body = $('leadsReadyBody');
            if (!page.length) { body.innerHTML = '<tr><td colspan="6" style="padding:20px;color:#94a3b8;font-size:13px;">No ready leads. Run discovery to get started.</td></tr>'; }
            else {
                body.innerHTML = page.map(function(l) {
                    var subj = (l.email_subject || '').substring(0, 50);
                    var checked = selectedLeadIds.has(String(l.id)) ? ' checked' : '';
                    return '<tr data-id="' + l.id + '">' +
                        '<td class="cb-col"><input type="checkbox" class="lead-cb" data-id="' + l.id + '"' + checked + ' /></td>' +
                        '<td style="font-weight:500;color:#0f172a;">' + esc(l.business_name) + '</td>' +
                        '<td>' + tradeBadge(l.trade_type) + '</td>' +
                        '<td>' + scorePill(l.audit_score) + '</td>' +
                        '<td class="subject-preview" title="' + esc(l.email_subject) + '">' + esc(subj || '—') + '</td>' +
                        '<td><button class="btn-sm btn-preview" data-id="' + l.id + '">Preview</button> <button class="btn-sm btn-gmail" data-id="' + l.id + '">Gmail</button> <button class="btn-sm btn-skip" data-id="' + l.id + '" title="Skip this lead">&#10005;</button></td>' +
                        '</tr>' +
                        '<tr class="expand-row-pipeline expand-' + l.id + '" style="display:none"><td colspan="6"><div class="label">To</div><div class="value">' + esc(l.email) + '</div><div class="label" style="margin-top:12px">Subject</div><div class="value">' + esc(l.email_subject) + '</div><div class="label" style="margin-top:12px">Body</div><div class="value body">' + esc(l.email_body) + '</div></td></tr>';
                }).join('');
            }
            renderPagination($('readyPagination'), readyPage, totalPages, function(p) { readyPage = p; renderReadyTable(leads); });
            attachReadyHandlers();
            updateSelectAllState(leads);
            updateSelectedCountLabel();
        }

        function renderSentTable(leads) {
            var totalPages = Math.max(1, Math.ceil(leads.length / PAGE_SIZE));
            if (sentPage > totalPages) sentPage = totalPages;
            var start = (sentPage - 1) * PAGE_SIZE;
            var page = leads.slice(start, start + PAGE_SIZE);
            var body = $('leadsSentBody');
            if (!page.length) body.innerHTML = '<tr><td colspan="4" style="padding:20px;color:#94a3b8;font-size:13px;">No sent emails yet.</td></tr>';
            else body.innerHTML = page.map(function(l) {
                return '<tr><td>' + esc(l.business_name) + '</td><td>' + tradeBadge(l.trade_type) + '</td><td class="subject-preview">' + esc((l.email_subject||'').substring(0,45)) + '</td><td class="sent-at">' + fmtSent(l.updated_at) + '</td></tr>';
            }).join('');
            renderPagination($('sentPagination'), sentPage, totalPages, function(p) { sentPage = p; renderSentTable(leads); });
        }

        function renderPagination(el, current, total, cb) {
            if (total <= 1) { el.classList.add('hidden'); return; }
            el.classList.remove('hidden');
            var html = '<button ' + (current <= 1 ? 'disabled' : '') + ' data-p="' + (current-1) + '">Prev</button>';
            html += '<span class="current">Page ' + current + ' of ' + total + '</span>';
            html += '<button ' + (current >= total ? 'disabled' : '') + ' data-p="' + (current+1) + '">Next</button>';
            el.innerHTML = html;
            el.querySelectorAll('button').forEach(function(b) { b.onclick = function() { cb(parseInt(this.getAttribute('data-p'),10)); }; });
        }

        function updateSendBtn() {
            var btn = $('sendAllNowBtn');
            var csv = $('prepareSendGmail');
            var readyLeads = getReadyLeads();
            var nReady = readyLeads.length;
            var nSelected = selectedLeadIds.size;
            if (nReady > 0) { btn.classList.remove('hidden'); csv.classList.remove('hidden'); }
            else { btn.classList.add('hidden'); csv.classList.add('hidden'); }
            if (nSelected === 0) {
                btn.textContent = 'Select emails to send';
                btn.disabled = true;
            } else if (dailySentCount >= dailyLimit) {
                btn.textContent = nSelected + ' selected (limit reached)';
                btn.disabled = true;
            } else {
                var canSend = Math.max(0, dailyLimit - dailySentCount);
                var toSend = Math.min(nSelected, canSend);
                if (toSend < nSelected) {
                    btn.textContent = 'Send ' + toSend + ' of ' + nSelected + ' selected (daily limit)';
                } else {
                    btn.textContent = 'Send ' + nSelected + ' Selected Email' + (nSelected === 1 ? '' : 's') + ' Now';
                }
                btn.disabled = operationRunning;
            }
        }

        function updateSelectAllState(leads) {
            var sa = $('selectAllReady');
            if (!sa) return;
            if (!leads || leads.length === 0) { sa.checked = false; sa.indeterminate = false; return; }
            var allChecked = leads.every(function(l) { return selectedLeadIds.has(String(l.id)); });
            var someChecked = leads.some(function(l) { return selectedLeadIds.has(String(l.id)); });
            sa.checked = allChecked;
            sa.indeterminate = !allChecked && someChecked;
        }

        function updateSelectedCountLabel() {
            var el = $('readySelectedCount');
            if (!el) return;
            var n = selectedLeadIds.size;
            el.textContent = n > 0 ? n + ' selected' : '';
        }

        function attachReadyHandlers() {
            $('leadsReadyBody').querySelectorAll('.lead-cb').forEach(function(cb) {
                cb.onchange = function() {
                    var id = this.getAttribute('data-id');
                    if (this.checked) selectedLeadIds.add(id);
                    else selectedLeadIds.delete(id);
                    updateSendBtn();
                    updateSelectAllState(getReadyLeads());
                    updateSelectedCountLabel();
                };
            });
            $('leadsReadyBody').querySelectorAll('.btn-preview').forEach(function(btn) {
                btn.onclick = function(e) { e.stopPropagation(); var id = this.getAttribute('data-id'); var ex = document.querySelector('.expand-' + id); if (ex) { var vis = ex.style.display !== 'none'; document.querySelectorAll('.expand-row-pipeline').forEach(function(r) { r.style.display = 'none'; }); ex.style.display = vis ? 'none' : 'table-row'; } };
            });
            $('leadsReadyBody').querySelectorAll('.btn-gmail').forEach(function(btn) {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    if (dailySentCount >= dailyLimit) { alert('Daily limit reached.'); return; }
                    var lead = leadsCache.find(function(l) { return String(l.id) === btn.getAttribute('data-id'); });
                    if (!lead || !lead.email) return;
                    window.open('mailto:' + lead.email + '?subject=' + encodeURIComponent(lead.email_subject || '') + '&body=' + encodeURIComponent(lead.email_body || ''), '_blank');
                };
            });
            $('leadsReadyBody').querySelectorAll('.btn-skip').forEach(function(btn) {
                btn.onclick = async function(e) {
                    e.stopPropagation();
                    var id = btn.getAttribute('data-id');
                    if (!confirm('Skip this lead?')) return;
                    try {
                        await fetch(API + '/api/lead/' + id + '/skip', { method: 'POST', headers: h() });
                        leadsCache = leadsCache.map(function(l) { if (String(l.id) === id) l.status = 'skip'; return l; });
                        renderLeads();
                        loadStats();
                    } catch (er) {}
                };
            });
        }

        /* Search/filter */
        $('pipelineSearch').oninput = function() { readyPage = 1; sentPage = 1; renderLeads(); };
        $('pipelineTradeFilter').onchange = function() { readyPage = 1; sentPage = 1; renderLeads(); };
        $('readyTradeFilter').onchange = function() { readyPage = 1; selectedLeadIds.clear(); renderLeads(); };
        $('selectAllReady').onchange = function() {
            var leads = getReadyLeads();
            if (this.checked) {
                leads.forEach(function(l) { selectedLeadIds.add(String(l.id)); });
            } else {
                leads.forEach(function(l) { selectedLeadIds.delete(String(l.id)); });
            }
            renderReadyTable(leads);
            updateSendBtn();
        };

        /* Run single trade discovery + audit + email */
        async function runPipeline(trade, city, target) {
            var inserted = 0;
            setBanner('busy', 'Finding ' + trade + ' businesses in ' + city + '...');
            setProgress(5);
            try {
                var r = await fetch(API + '/api/leads/autopilot/discovery', { method: 'POST', headers: h(), body: JSON.stringify({ trade_type: trade, suburb: '', city: city, target_count: target }) });
                var d = await r.json().catch(function() { return {}; });
                inserted = d.inserted || 0;
            } catch (e) {}
            setProgress(33);
            setBanner('busy', 'Auditing websites...');
            try { await fetch(API + '/api/leads/autopilot/audit', { method: 'POST', headers: h(), body: JSON.stringify({}) }); } catch (e) {}
            setProgress(66);
            setBanner('busy', 'Writing emails...');
            try { await fetch(API + '/api/leads/autopilot/email-writing', { method: 'POST', headers: h(), body: JSON.stringify({}) }); } catch (e) {}
            setProgress(100);
            return inserted;
        }

        $('runSingle').onclick = async function() {
            setOperationState(true);
            var trade = getSelectedTrade();
            var city = getCity();
            var target = getTarget();
            var btn = $('runSingle');
            btn.textContent = 'Finding...';
            var inserted = await runPipeline(trade, city, target);
            btn.textContent = 'Find Leads';
            await loadLeads();
            setOperationState(false);
            flashSuccess('Done! Found ' + inserted + ' new ' + trade + ' leads.');
        };

        $('runAllTrades').onclick = async function() {
            setOperationState(true);
            var city = getCity();
            var target = getTarget();
            var btn = $('runAllTrades');
            btn.textContent = 'Running...';
            var totalInserted = 0;
            var results = [];
            for (var i = 0; i < TRADES.length; i++) {
                setBanner('busy', 'Finding ' + TRADES[i] + ' (' + (i+1) + '/' + TRADES.length + ')...');
                setProgress((i / TRADES.length) * 100);
                var ins = await runPipeline(TRADES[i], city, target);
                totalInserted += ins;
                results.push(TRADES[i] + ': ' + ins);
                await loadLeads();
            }
            btn.textContent = 'All Trades';
            setOperationState(false);
            flashSuccess('All trades done! ' + results.join(', ') + '. Total: ' + totalInserted + ' new leads.');
        };

        $('runAllPro').onclick = async function() {
            setOperationState(true);
            var city = getCity();
            var target = getTarget();
            var btn = $('runAllPro');
            btn.textContent = 'Running...';
            var totalInserted = 0;
            var results = [];
            for (var i = 0; i < PRO_TRADES.length; i++) {
                setBanner('busy', 'Finding ' + PRO_TRADES[i] + ' (' + (i+1) + '/' + PRO_TRADES.length + ')...');
                setProgress((i / PRO_TRADES.length) * 100);
                var ins = await runPipeline(PRO_TRADES[i], city, target);
                totalInserted += ins;
                results.push(PRO_TRADES[i] + ': ' + ins);
                await loadLeads();
            }
            btn.textContent = 'All Professional';
            setOperationState(false);
            flashSuccess('All professional services done! ' + results.join(', ') + '. Total: ' + totalInserted + ' new leads.');
        };

        $('dailyBatchBtn').onclick = async function() {
            setOperationState(true);
            var city = getCity();
            var btn = $('dailyBatchBtn');
            btn.textContent = 'Running...';
            var totalInserted = 0;
            var results = [];
            for (var i = 0; i < ALL_TRADES.length; i++) {
                setBanner('busy', 'Running ' + ALL_TRADES[i] + '... (' + (i+1) + '/' + ALL_TRADES.length + ')');
                setProgress((i / ALL_TRADES.length) * 100);
                var ins = await runPipeline(ALL_TRADES[i], city, 10);
                totalInserted += ins;
                results.push(ALL_TRADES[i] + ': found ' + ins);
                await loadLeads();
            }
            btn.textContent = 'Run Daily Batch';
            await loadLeads();
            setOperationState(false);
            var readyN = leadsCache.filter(function(l) { return l.status === 'ready' && l.email; }).length;
            flashSuccess('Done! ' + results.join('. ') + '. Total: ' + totalInserted + ' new leads, ' + readyN + ' emails ready to send.');
        };

        /* Send */
        var sendProgressInterval = null;
        $('sendAllNowBtn').onclick = async function() {
            if (dailySentCount >= dailyLimit) { alert('Daily limit reached.'); return; }
            if (selectedLeadIds.size === 0) { alert('No leads selected.'); return; }
            var ids = Array.from(selectedLeadIds);
            setOperationState(true);
            var btn = $('sendAllNowBtn');
            btn.textContent = 'Sending... 0 of ?';
            setBanner('busy', 'Sending selected emails...');
            setProgress(0);
            try {
                var r = await fetch(API + '/api/leads/autopilot/send-selected', {
                    method: 'POST', headers: h(),
                    body: JSON.stringify({ lead_ids: ids.map(function(id) { return parseInt(id, 10); }) })
                });
                var data = await r.json().catch(function() { return {}; });
                if (!data.ok || !(data.to_send > 0)) {
                    btn.textContent = 'Select emails to send';
                    setOperationState(false);
                    updateIdleBanner();
                    return;
                }
                var totalToSend = data.to_send;
                var sentSoFar = 0;
                var completed = false;
                sendProgressInterval = setInterval(async function() {
                    if (completed) return;
                    try {
                        var r2 = await fetch(API + '/api/leads/autopilot/log?since_id=' + lastLogId + '&limit=200', { headers: h() });
                        if (!r2.ok) return;
                        var ld = await r2.json();
                        (ld.log || []).forEach(function(e) {
                            if (e.id > lastLogId) lastLogId = e.id;
                            if (e.phase === 'send') {
                                if ((e.message||'').indexOf('Sent ✓') >= 0) sentSoFar++;
                                if ((e.message||'').indexOf('Sending complete:') >= 0) completed = true;
                            }
                        });
                        btn.textContent = 'Sending... ' + sentSoFar + ' of ' + totalToSend;
                        setBanner('busy', 'Sending emails (' + sentSoFar + '/' + totalToSend + ')...');
                        setProgress(totalToSend ? (sentSoFar / totalToSend) * 100 : 0);
                        if (completed) {
                            clearInterval(sendProgressInterval); sendProgressInterval = null;
                            selectedLeadIds.clear();
                            await loadLeads();
                            setOperationState(false);
                            flashSuccess('Sent ' + sentSoFar + ' emails!');
                        }
                    } catch (e) {}
                }, 2000);
            } catch (e) {
                if (sendProgressInterval) { clearInterval(sendProgressInterval); sendProgressInterval = null; }
                setOperationState(false);
                updateIdleBanner();
            }
        };

        /* CSV backup */
        var GMAIL_SCRIPT = 'function sendEmails() {\n  var sheet = SpreadsheetApp.getActiveSheet();\n  var data = sheet.getDataRange().getValues();\n  var headers = data[0];\n  var emailCol = headers.indexOf("Email Address");\n  var subjectCol = headers.indexOf("Email Subject");\n  var bodyCol = headers.indexOf("Email Body");\n  var sent = 0;\n  for (var i = 1; i < data.length; i++) {\n    var email = data[i][emailCol];\n    var subject = data[i][subjectCol];\n    var body = data[i][bodyCol];\n    if (email && subject && body) {\n      try {\n        GmailApp.sendEmail(email, subject, body, { name: "Abbed", replyTo: "abbed@motionmadebne.com.au" });\n        sheet.getRange(i+1, headers.length+1).setValue("SENT");\n        sent++;\n        Utilities.sleep(30000);\n      } catch (e) { sheet.getRange(i+1, headers.length+1).setValue("FAILED: "+e.message); }\n    }\n  }\n  SpreadsheetApp.getUi().alert("Done! Sent "+sent+" emails.");\n}';
        function csvEsc(s) { if (s==null) return '""'; var t = String(s).replace(/"/g,'""'); return /[",\r\n]/.test(t) ? '"'+t+'"' : t; }
        $('prepareSendGmail').onclick = function() {
            var ready = leadsCache.filter(function(l) { return l.status==='ready'&&l.email; });
            if (!ready.length) return;
            var rows = [['Business Name','Email Address','Email Subject','Email Body','Status']];
            ready.forEach(function(l) { rows.push([l.business_name||'',l.email||'',l.email_subject||'',l.email_body||'','']); });
            var csv = rows.map(function(r) { return r.map(csvEsc).join(','); }).join('\r\n');
            var a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = 'leads_gmail.csv'; a.click();
            $('gmailScriptPre').textContent = GMAIL_SCRIPT;
            $('gmailScriptModal').classList.remove('hidden');
        };
        $('copyScriptBtn').onclick = function() { navigator.clipboard.writeText(GMAIL_SCRIPT).catch(function(){}); };
        $('closeScriptModalBtn').onclick = function() { $('gmailScriptModal').classList.add('hidden'); };
        $('gmailScriptModal').onclick = function(e) { if (e.target.id === 'gmailScriptModal') e.target.classList.add('hidden'); };

        /* Export */
        $('exportCsv').onclick = async function() {
            var url = API + '/api/leads/export?';
            var r = await fetch(url, { headers: h() });
            if (!r.ok) return;
            var blob = await r.blob();
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'leads_export.csv'; a.click();
        };

        /* Log polling with smart auto-scroll */
        var logPanel = $('logPanel');
        logPanel.addEventListener('scroll', function() {
            logAutoScroll = (logPanel.scrollHeight - logPanel.scrollTop - logPanel.clientHeight) < 30;
        });
        async function pollLog() {
            try {
                var r = await fetch(API + '/api/leads/autopilot/log?since_id=' + lastLogId + '&limit=80', { headers: h() });
                if (!r.ok) return;
                var d = await r.json();
                (d.log || []).forEach(function(e) {
                    if (e.id > lastLogId) lastLogId = e.id;
                    var div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = '<span class="log-time">' + (e.created_at ? new Date(e.created_at).toLocaleTimeString() : '') + '</span><span class="log-phase">[' + esc(e.phase||'') + ']</span> ' + esc(e.message||'');
                    logPanel.appendChild(div);
                });
                if (logAutoScroll) logPanel.scrollTop = logPanel.scrollHeight;
            } catch (e) {}
        }
        $('clearLog').onclick = async function(e) {
            e.preventDefault();
            try { await fetch(API + '/api/leads/autopilot/clear-log', { method: 'POST', headers: h() }); } catch (er) {}
            logPanel.innerHTML = '';
        };

        $('refreshLeads').onclick = function() { loadLeads(); };
        $('city').onchange = function() {};

        function logout() {
            adminToken = '';
            try { localStorage.removeItem('leads_admin_token'); } catch (z) {}
            $('authSection').classList.remove('hidden');
            $('mainContent').classList.add('hidden');
            $('adminToken').value = '';
            $('authError').textContent = 'Session expired. Please log in again.';
        }

        function enterApp() {
            try { localStorage.setItem('leads_admin_token', adminToken); } catch (z) {}
            $('authSection').classList.add('hidden');
            $('mainContent').classList.remove('hidden');
            loadLeads();
            setInterval(pollLog, 2500);
            pollLog();
        }

        /* Login */
        $('loginBtn').onclick = async function() {
            var token = $('adminToken').value.trim();
            if (!token) { $('authError').textContent = 'Token required'; return; }
            adminToken = token;
            $('authError').textContent = '';
            try {
                var r = await fetch(API + '/api/leads', { headers: h() });
                if (r.status === 401) { $('authError').textContent = 'Invalid token'; adminToken = ''; return; }
                if (!r.ok) throw new Error('HTTP ' + r.status);
                enterApp();
            } catch (e) { $('authError').textContent = e.message || 'Login failed'; }
        };

        /* Auto-login from saved token */
        (async function() {
            var saved;
            try { saved = localStorage.getItem('leads_admin_token'); } catch (z) {}
            if (!saved) return;
            adminToken = saved;
            try {
                var r = await fetch(API + '/api/leads', { headers: h() });
                if (r.status === 401) { adminToken = ''; try { localStorage.removeItem('leads_admin_token'); } catch (z) {} return; }
                if (!r.ok) return;
                enterApp();
            } catch (e) {}
        })();
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotionMade – Lead Engine</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: #111827; font-size: 16px; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        header { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 700; color: #2563EB; }
        .auth-section { background: #fff; padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #e5e7eb; }
        .auth-section input { padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; width: 280px; margin-right: 10px; }
        .auth-section button { padding: 10px 18px; background: #2563EB; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .auth-section button:hover { background: #1d4ed8; }
        .error { color: #dc2626; margin-top: 10px; }
        .success { color: #059669; margin-top: 10px; }

        .controls { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 24px; display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-group label { font-size: 12px; color: #6b7280; font-weight: 500; }
        .control-group input, .control-group select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 140px; }
        .btn { padding: 10px 18px; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 14px; border: none; }
        .btn-primary { background: #2563EB; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-success { background: #059669; color: white; }
        .btn-success:hover { background: #047857; }
        .btn-success:disabled { opacity: 0.6; cursor: not-allowed; }

        .pipeline-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; }
        .pipeline-header h2 { font-size: 20px; font-weight: 600; }
        .log-panel { background: #1f2937; color: #e5e7eb; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 13px; max-height: 220px; overflow-y: auto; margin-bottom: 24px; }
        .log-panel .log-entry { margin-bottom: 6px; }
        .log-panel .log-phase { color: #93c5fd; }
        .log-panel .log-time { color: #9ca3af; margin-right: 8px; }

        .leads-table-wrap { overflow-x: auto; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; }
        table.leads-table { width: 100%; border-collapse: collapse; }
        .leads-table th, .leads-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .leads-table th { background: #f9fafb; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #6b7280; }
        .leads-table tr:hover { background: #f9fafb; }
        .leads-table .status { font-size: 12px; padding: 2px 8px; border-radius: 6px; font-weight: 500; }
        .leads-table .status-new { background: #e0e7ff; color: #3730a3; }
        .leads-table .status-audited { background: #fef3c7; color: #92400e; }
        .leads-table .status-previewed { background: #d1fae5; color: #065f46; }
        .leads-table .status-ready { background: #dbeafe; color: #1d4ed8; }
        .leads-table .status-emailed { background: #e5e7eb; color: #374151; }
        .leads-table .status-replied { background: #d1fae5; color: #065f46; }
        .leads-table .status-converted { background: #059669; color: white; }
        .leads-table .status-skip { background: #f3f4f6; color: #6b7280; }
        .leads-table a { color: #2563EB; text-decoration: none; }
        .leads-table a:hover { text-decoration: underline; }
        .leads-table .email-preview { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; color: #6b7280; }
        .leads-table .send-cell { white-space: nowrap; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <span class="logo">MotionMade Lead Engine</span>
    </header>
    <div class="container">
        <div class="auth-section" id="authSection">
            <h2 style="margin-bottom: 12px;">Admin token</h2>
            <input type="password" id="adminToken" placeholder="Enter admin token" />
            <button id="loginBtn" class="btn btn-primary">Login</button>
            <div id="authError" class="error"></div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="controls">
                <div class="control-group">
                    <label>Trade type</label>
                    <input type="text" id="tradeType" placeholder="e.g. plumber" value="plumber" />
                </div>
                <div class="control-group">
                    <label>Brisbane suburb</label>
                    <select id="suburb"><option value="">Loading...</option></select>
                </div>
                <div class="control-group">
                    <label>Target leads</label>
                    <select id="targetCount">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <button id="runDiscovery" class="btn btn-primary">1. Run Discovery</button>
                <button id="runAudit" class="btn btn-primary">2. Run Audit</button>
                <button id="runPreview" class="btn btn-primary">3. Generate Previews</button>
                <button id="runEmailWriting" class="btn btn-primary">4. Write Emails</button>
                <button id="sendAllReady" class="btn btn-success">Send All Ready</button>
                <button id="exportCsv" class="btn btn-secondary">Export CSV</button>
            </div>

            <h3 style="margin-bottom: 8px;">Live log</h3>
            <div class="log-panel" id="logPanel"></div>

            <div class="pipeline-header">
                <h2>Pipeline</h2>
                <button id="refreshLeads" class="btn btn-secondary">Refresh</button>
            </div>
            <div class="leads-table-wrap">
                <table class="leads-table" id="leadsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Website</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Preview</th>
                            <th>Email</th>
                            <th>Send</th>
                        </tr>
                    </thead>
                    <tbody id="leadsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let adminToken = '';

        function getHeaders() {
            return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminToken };
        }

        function showAuthError(msg) {
            document.getElementById('authError').textContent = msg || '';
        }

        document.getElementById('loginBtn').onclick = async function() {
            const token = document.getElementById('adminToken').value.trim();
            if (!token) { showAuthError('Token required'); return; }
            adminToken = token;
            showAuthError('');
            try {
                const r = await fetch(API_BASE + '/api/leads', { headers: getHeaders() });
                if (r.status === 401) { showAuthError('Invalid token'); return; }
                if (!r.ok) throw new Error('HTTP ' + r.status);
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadSuburbs();
                loadLeads();
                startLogPolling();
            } catch (e) {
                showAuthError(e.message || 'Login failed');
            }
        };

        async function loadSuburbs() {
            const r = await fetch(API_BASE + '/api/leads/suburbs', { headers: getHeaders() });
            if (!r.ok) return;
            const data = await r.json();
            const sel = document.getElementById('suburb');
            sel.innerHTML = '<option value="">All</option>' + (data.suburbs || []).map(s => '<option value="' + s + '">' + s + '</option>').join('');
        }

        async function loadLeads() {
            const trade = document.getElementById('tradeType').value.trim();
            const suburb = document.getElementById('suburb').value;
            let url = API_BASE + '/api/leads?';
            if (trade) url += 'trade_type=' + encodeURIComponent(trade) + '&';
            if (suburb) url += 'suburb=' + encodeURIComponent(suburb) + '&';
            const r = await fetch(url, { headers: getHeaders() });
            if (!r.ok) return;
            const data = await r.json();
            const tbody = document.getElementById('leadsBody');
            tbody.innerHTML = (data.leads || []).map(lead => {
                const statusClass = 'status-' + (lead.status || 'new');
                const previewLink = lead.preview_url ? '<a href="' + lead.preview_url + '" target="_blank" rel="noopener">View</a>' : '–';
                const emailPreview = (lead.email_subject || '').substring(0, 40) + (lead.email_subject && lead.email_subject.length > 40 ? '…' : '');
                const sendBtn = (lead.status === 'ready' && lead.email) ? '<button class="btn btn-primary btn-send-one" data-id="' + lead.id + '">Send</button>' : '–';
                return '<tr>' +
                    '<td>' + escapeHtml(lead.business_name || '') + '</td>' +
                    '<td>' + (lead.website ? '<a href="' + escapeHtml(lead.website) + '" target="_blank" rel="noopener">' + escapeHtml(lead.website) + '</a>' : '–') + '</td>' +
                    '<td>' + escapeHtml(lead.email || '') + '</td>' +
                    '<td><span class="status ' + statusClass + '">' + (lead.status || 'new') + '</span></td>' +
                    '<td>' + (lead.audit_score != null ? lead.audit_score : '–') + '</td>' +
                    '<td>' + previewLink + '</td>' +
                    '<td class="email-preview" title="' + escapeHtml(lead.email_subject || '') + '">' + escapeHtml(emailPreview) + '</td>' +
                    '<td class="send-cell">' + sendBtn + '</td>' +
                    '</tr>';
            }).join('') || '<tr><td colspan="8">No leads yet. Run Discovery.</td></tr>';

            tbody.querySelectorAll('.btn-send-one').forEach(btn => {
                btn.onclick = async function() {
                    const id = this.getAttribute('data-id');
                    const r = await fetch(API_BASE + '/api/leads/' + id, { headers: getHeaders() });
                    if (!r.ok) { alert('Could not load lead'); return; }
                    const lead = await r.json();
                    sendOne(lead.email, lead.email_subject || '', lead.email_body || '', lead.business_name, id);
                };
            });
        }

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        async function sendOne(email, subject, body, leadName, leadId) {
            try {
                const r = await fetch(API_BASE + '/api/outreach/send', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ to_email: email, subject: subject, body: body, from_name: 'Abbed', reply_to: 'abbed@motionmadebne.com.au', lead_name: leadName })
                });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.detail || 'HTTP ' + r.status);
                await fetch(API_BASE + '/api/leads/' + leadId, { method: 'PATCH', headers: getHeaders(), body: JSON.stringify({ status: 'emailed' }) });
                loadLeads();
            } catch (e) {
                alert(e.message || 'Send failed');
            }
        }

        async function runPhase(endpoint, body, btnId) {
            const btn = document.getElementById(btnId);
            btn.disabled = true;
            try {
                const r = await fetch(API_BASE + endpoint, { method: 'POST', headers: getHeaders(), body: JSON.stringify(body || {}) });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.detail || 'HTTP ' + r.status);
                loadLeads();
            } catch (e) {
                alert(e.message || 'Request failed');
            } finally {
                btn.disabled = false;
            }
        }

        document.getElementById('runDiscovery').onclick = () => runPhase('/api/leads/autopilot/discovery', {
            trade_type: document.getElementById('tradeType').value.trim() || 'plumber',
            suburb: document.getElementById('suburb').value || 'Brisbane City',
            target_count: parseInt(document.getElementById('targetCount').value, 10) || 20
        }, 'runDiscovery');

        document.getElementById('runAudit').onclick = () => runPhase('/api/leads/autopilot/audit', {}, 'runAudit');
        document.getElementById('runPreview').onclick = () => runPhase('/api/leads/autopilot/preview', {}, 'runPreview');
        document.getElementById('runEmailWriting').onclick = () => runPhase('/api/leads/autopilot/email-writing', {}, 'runEmailWriting');

        document.getElementById('sendAllReady').onclick = async function() {
            const btn = this;
            btn.disabled = true;
            try {
                const r = await fetch(API_BASE + '/api/leads/send-all-ready', { method: 'POST', headers: getHeaders() });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.detail || 'HTTP ' + r.status);
                loadLeads();
            } catch (e) {
                alert(e.message || 'Send failed');
            } finally {
                btn.disabled = false;
            }
        };

        document.getElementById('exportCsv').onclick = async function() {
            const trade = document.getElementById('tradeType').value.trim();
            const suburb = document.getElementById('suburb').value;
            let url = API_BASE + '/api/leads/export?';
            if (trade) url += 'trade_type=' + encodeURIComponent(trade) + '&';
            if (suburb) url += 'suburb=' + encodeURIComponent(suburb);
            const r = await fetch(url, { headers: getHeaders() });
            if (!r.ok) { alert('Export failed'); return; }
            const blob = await r.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'leads_export.csv';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
        };

        document.getElementById('refreshLeads').onclick = loadLeads;

        let lastLogId = 0;
        async function pollLog() {
            try {
                const r = await fetch(API_BASE + '/api/leads/autopilot/log?since_id=' + lastLogId + '&limit=50', { headers: getHeaders() });
                if (!r.ok) return;
                const data = await r.json();
                const log = data.log || [];
                const panel = document.getElementById('logPanel');
                log.forEach(entry => {
                    if (entry.id > lastLogId) lastLogId = entry.id;
                    const time = entry.created_at ? new Date(entry.created_at).toLocaleTimeString() : '';
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = '<span class="log-time">' + time + '</span><span class="log-phase">[' + escapeHtml(entry.phase || '') + ']</span> ' + escapeHtml(entry.message || '');
                    panel.appendChild(div);
                });
                if (panel.children.length) panel.scrollTop = panel.scrollHeight;
            } catch (_) {}
        }
        function startLogPolling() {
            pollLog();
            setInterval(pollLog, 2500);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotionMade AI ‚Äì Your Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FFFFFF;
            color: #374151;
            font-size: 16px;
            line-height: 1.5;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 24px; }
        @media (max-width: 480px) { .container { padding: 16px; } }

        /* Header */
        .dash-header {
            background: #FFFFFF;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 0 24px;
            margin-bottom: 24px;
        }
        .dash-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .dash-logo { font-size: 16px; font-weight: 600; color: #2563EB; }
        .logout-btn {
            padding: 10px 18px;
            min-height: 44px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .logout-btn:hover { background: #e5e7eb; }
        .dash-greeting { font-size: 26px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .dash-tenant { font-size: 14px; color: #6B7280; }

        /* Stats cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        @media (max-width: 640px) {
            .cards { grid-template-columns: 1fr; }
        }
        .card {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 140px;
            display: flex;
            flex-direction: column;
        }
        .card .label {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 8px;
        }
        .card .value {
            font-size: 48px;
            font-weight: 700;
            color: #111827;
            line-height: 1.1;
        }
        .card .sublabel {
            font-size: 14px;
            color: #6B7280;
            margin-top: 6px;
        }
        .card .trend {
            font-size: 14px;
            margin-top: 4px;
        }
        .card .trend.up { color: #059669; }
        .card .trend.down { color: #dc2626; }
        .card a.faq-link {
            color: #2563EB;
            font-size: 14px;
            margin-top: auto;
            padding-top: 12px;
            display: inline-block;
        }
        .card a.faq-link:hover { text-decoration: underline; }

        /* Empty state ‚Äì onboarding checklist */
        .empty-state {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 32px 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .empty-state h2 {
            font-size: 22px;
            color: #111827;
            margin-bottom: 12px;
        }
        .empty-state p.lead {
            font-size: 16px;
            color: #6B7280;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        .empty-state .checklist {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 24px;
        }
        .empty-state .check-item {
            margin-bottom: 20px;
        }
        .empty-state .check-item:last-child { margin-bottom: 0; }
        .empty-state .check-item h4 { font-size: 15px; color: #111827; margin-bottom: 8px; }
        .empty-state .check-item p { font-size: 14px; color: #6B7280; margin-bottom: 10px; }
        .empty-state .embed-inline {
            background: #f3f4f6;
            padding: 12px 12px 12px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            position: relative;
            margin-bottom: 10px;
        }
        .empty-state .embed-inline pre { margin: 0; padding-right: 80px; }
        .empty-state .copy-inline {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 14px;
            background: #2563EB;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .empty-state .copy-inline.copied { background: #059669; }

        /* Chart */
        .chart-wrap {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .chart-wrap h2 { font-size: 18px; color: #111827; margin-bottom: 16px; }
        .period-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .period-tabs button {
            padding: 10px 18px;
            min-height: 44px;
            border: 1px solid #e5e7eb;
            background: #FFFFFF;
            border-radius: 999px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
        }
        .period-tabs button.active {
            background: #2563EB;
            color: white;
            border-color: #2563EB;
        }
        .period-tabs button:not(.active):hover { background: #f9fafb; }
        .chart-container { position: relative; height: 260px; min-height: 200px; }
        .chart-insight { font-size: 14px; color: #6B7280; margin-top: 16px; }

        /* Your Questions & Answers */
        .faq-section {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .faq-section-title { font-size: 18px; color: #111827; margin-bottom: 8px; }
        .faq-section-desc { font-size: 14px; color: #6B7280; margin-bottom: 20px; line-height: 1.5; }
        .faq-warning-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .faq-list { margin-bottom: 16px; }
        .faq-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .faq-card.editing { border-left: 4px solid #2563EB; }
        .faq-card .faq-q { font-weight: 600; color: #111827; margin-bottom: 8px; }
        .faq-card .faq-a { font-size: 14px; color: #6B7280; line-height: 1.5; white-space: pre-wrap; }
        .faq-card-actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
        .faq-edit-btn, .faq-delete-btn {
            padding: 8px 14px;
            min-height: 40px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }
        .faq-edit-btn { background: #2563EB; color: white; }
        .faq-edit-btn:hover { background: #1d4ed8; }
        .faq-delete-btn { background: #f3f4f6; color: #374151; }
        .faq-delete-btn:hover { background: #e5e7eb; }
        .faq-empty-state { margin-bottom: 16px; }
        .faq-empty-state p { font-size: 14px; color: #6B7280; margin-bottom: 12px; }
        .faq-add-btn {
            padding: 10px 18px;
            min-height: 44px;
            background: #f3f4f6;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            width: 100%;
            max-width: 320px;
        }
        .faq-add-btn:hover { background: #e5e7eb; border-color: #9ca3af; }
        .faq-form-wrap { margin-top: 16px; }
        .faq-form {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #2563EB;
            border-radius: 8px;
            padding: 20px;
        }
        .faq-form label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px; }
        .faq-form input, .faq-form textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
            font-family: inherit;
        }
        .faq-form textarea { min-height: 80px; resize: vertical; }
        .faq-form-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .faq-save-btn, .faq-cancel-btn {
            padding: 10px 18px;
            min-height: 44px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }
        .faq-save-btn { background: #2563EB; color: white; }
        .faq-save-btn:hover { background: #1d4ed8; }
        .faq-save-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .faq-cancel-btn { background: #f3f4f6; color: #374151; }
        .faq-cancel-btn:hover { background: #e5e7eb; }
        .faq-success-msg { color: #059669; font-size: 14px; margin-top: 8px; }
        @media (max-width: 480px) { .faq-form-actions { flex-direction: column; } .faq-add-btn { max-width: none; } }

        /* Widget install section */
        .embed-section {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .embed-section h2 { font-size: 18px; color: #111827; margin-bottom: 12px; }
        .embed-code {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            position: relative;
            margin-bottom: 16px;
        }
        .embed-code pre { margin: 0; white-space: pre-wrap; word-break: break-all; }
        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 8px 14px;
            min-height: 36px;
            background: #2563EB;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .copy-btn:hover { background: #1d4ed8; }
        .copy-btn.copied { background: #059669; }
        .install-details { margin-top: 16px; }
        .install-details summary {
            cursor: pointer;
            font-size: 14px;
            color: #2563EB;
            font-weight: 500;
        }
        .install-details ul { margin: 12px 0 0 20px; padding: 0; font-size: 14px; color: #6B7280; line-height: 1.7; }

        /* Footer */
        footer {
            text-align: center;
            padding: 24px 0;
            border-top: 1px solid #e5e7eb;
        }
        footer .contact { font-size: 14px; color: #374151; margin-bottom: 8px; }
        footer .contact a { color: #2563EB; }
        footer .powered { font-size: 13px; color: #9ca3af; }

        #dashboardError {
            background: #fef2f2;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .loading { opacity: 0.7; pointer-events: none; }
        .spinner-wrap {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
        }
        .spinner-wrap.visible { display: block; }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563EB;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="spinner-wrap" id="spinnerWrap" aria-hidden="true">
        <div class="spinner"></div>
    </div>
    <div class="container">
        <div id="dashboardError" style="display: none;"></div>

        <header class="dash-header">
            <div class="dash-header-top">
                <span class="dash-logo">MotionMade AI</span>
                <button type="button" class="logout-btn" id="logoutBtn">Logout</button>
            </div>
            <h1 class="dash-greeting" id="greeting">G'day üëã</h1>
            <p class="dash-tenant" id="tenantName">‚Äì</p>
        </header>

        <!-- Empty state: onboarding checklist (when no data in last 30 days) -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <h2>üöÄ You're all set up!</h2>
            <p class="lead">Your instant answers widget is ready to go. Once it's installed on your website, you'll start seeing stats here.</p>
            <div class="checklist">
                <div class="check-item">
                    <h4>Step 1: Install the widget</h4>
                    <p>Copy the code below and paste it on your website before <code>&lt;/body&gt;</code></p>
                    <div class="embed-inline">
                        <pre id="emptyStateSnippet"></pre>
                        <button type="button" class="copy-inline" id="emptyStateCopy">Copy</button>
                    </div>
                </div>
                <div class="check-item">
                    <h4>Step 2: Try it out</h4>
                    <p>Visit your website and click "Got a question?" to test it.</p>
                </div>
                <div class="check-item">
                    <h4>Step 3: Watch the stats</h4>
                    <p>Once customers start using it, your stats will appear right here.</p>
                </div>
            </div>
        </div>

        <!-- Stats cards (when there IS data) -->
        <div id="statsSection" style="display: none;">
            <div class="cards">
                <div class="card">
                    <div class="label">This Week</div>
                    <div class="value" id="statWeek">0</div>
                    <div class="trend" id="statTrend"></div>
                    <div class="sublabel">questions answered</div>
                </div>
                <div class="card">
                    <div class="label">Today</div>
                    <div class="value" id="statToday">0</div>
                    <div class="sublabel">questions answered</div>
                </div>
                <div class="card">
                    <div class="label">Couldn't Answer</div>
                    <div class="value" id="statFallback">0</div>
                    <a href="#" id="addFaqLink" class="faq-link">Add more FAQs ‚Üí</a>
                </div>
            </div>

            <!-- Chart (only when data) -->
            <div class="chart-wrap">
                <h2>Questions answered</h2>
                <div class="period-tabs">
                    <button type="button" data-period="7d" class="active">Last 7 days</button>
                    <button type="button" data-period="30d">Last 30 days</button>
                    <button type="button" data-period="90d">Last 90 days</button>
                </div>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
                <p class="chart-insight" id="busiestDayInsight"></p>
            </div>
        </div>

        <!-- Your Questions & Answers (owner FAQ self-service) -->
        <div class="faq-section" id="faqSection">
            <h2 class="faq-section-title">Your Questions & Answers</h2>
            <p class="faq-section-desc">These are the questions your widget can answer. Add, edit, or remove them anytime.</p>
            <div id="faqWarningBanner" class="faq-warning-banner" style="display: none;" role="alert"></div>
            <div id="faqList" class="faq-list"></div>
            <div id="faqEmptyState" class="faq-empty-state" style="display: none;">
                <p>You don't have any questions set up yet. Add your first one below.</p>
                <button type="button" class="faq-add-btn" id="faqAddBtnEmpty">+ Add a question</button>
            </div>
            <button type="button" class="faq-add-btn" id="faqAddBtn">+ Add a question</button>
            <div id="faqAddForm" class="faq-form-wrap" style="display: none;">
                <div class="faq-form">
                    <label for="faqNewQuestion">Question:</label>
                    <input type="text" id="faqNewQuestion" placeholder="e.g. What payment methods do you accept?" />
                    <label for="faqNewAnswer">Answer:</label>
                    <textarea id="faqNewAnswer" rows="4" minlength="1" placeholder="e.g. Cash, card, bank transfer, and Afterpay. Invoice emailed after the job."></textarea>
                    <div class="faq-form-actions">
                        <button type="button" class="faq-save-btn" id="faqSaveNewBtn">Save</button>
                        <button type="button" class="faq-cancel-btn" id="faqCancelNewBtn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget install (always visible) -->
        <div class="embed-section">
            <h2>Your widget</h2>
            <div class="embed-code">
                <pre id="embedSnippet"></pre>
                <button type="button" class="copy-btn" id="copyEmbedBtn">Copy</button>
            </div>
            <p style="font-size: 14px; color: #6B7280; margin-bottom: 12px;">Paste this before the <code>&lt;/body&gt;</code> tag on your website.</p>
            <details class="install-details">
                <summary>How to install</summary>
                <ul>
                    <li><strong>WordPress:</strong> Appearance ‚Üí Theme Editor ‚Üí footer.php ‚Üí paste before &lt;/body&gt;</li>
                    <li><strong>Squarespace:</strong> Settings ‚Üí Advanced ‚Üí Code Injection ‚Üí Footer ‚Üí paste</li>
                    <li><strong>Wix:</strong> Settings ‚Üí Custom Code ‚Üí Add Code ‚Üí Body End ‚Üí paste</li>
                    <li><strong>Other:</strong> Paste the code before &lt;/body&gt; in your site's HTML</li>
                </ul>
            </details>
        </div>

        <footer>
            <p class="contact">Need help? Contact Abbed ‚Äî <a href="tel:0400000000">0400 000 000</a></p>
            <p class="powered">Powered by MotionMade AI</p>
        </footer>
    </div>
    <script>
        (function () {
            var token = localStorage.getItem('owner_token');
            if (!token) {
                window.location.href = '/dashboard/login';
                return;
            }
            var currentPeriod = '7d';
            var chart = null;
            var tenantId = '';
            var tenantName = '';
            var hasAnyData = false;

            function authHeaders() { return { 'Authorization': 'Bearer ' + token }; }

            function showError(msg) {
                var el = document.getElementById('dashboardError');
                el.textContent = msg;
                el.style.display = 'block';
            }
            function hideError() {
                document.getElementById('dashboardError').style.display = 'none';
            }

            function loadMe() {
                return fetch('/owner/me', { headers: authHeaders() }).then(function (res) {
                    if (res.status === 401) {
                        localStorage.removeItem('owner_token');
                        window.location.href = '/dashboard/login';
                        throw new Error('Session expired');
                    }
                    if (!res.ok) throw new Error('Failed to load profile');
                    return res.json();
                });
            }

            function loadDashboard(period) {
                return fetch('/owner/dashboard?period=' + (period || currentPeriod), { headers: authHeaders() })
                    .then(function (res) {
                        if (res.status === 401) {
                            localStorage.removeItem('owner_token');
                            window.location.href = '/dashboard/login';
                            throw new Error('Session expired');
                        }
                        if (!res.ok) throw new Error('Failed to load stats');
                        return res.json();
                    });
            }

            function loadDaily(period) {
                return fetch('/owner/dashboard/daily?period=' + (period || currentPeriod), { headers: authHeaders() })
                    .then(function (res) { return res.ok ? res.json() : []; });
            }

            function setEmbedSnippet() {
                var base = window.location.origin;
                var snippet = '<!-- MotionMade AI - Instant Answers for ' + (tenantName || 'Your Business') + ' -->\n<script src="' + base + '/widget.js"\n  data-tenant="' + (tenantId || '') + '"\n  data-color="#2563EB"\n  data-name="' + (tenantName || '') + '"\n  data-api="' + base + '"><\/script>';
                var el = document.getElementById('embedSnippet');
                if (el) el.textContent = snippet;
                var emptyEl = document.getElementById('emptyStateSnippet');
                if (emptyEl) emptyEl.textContent = snippet;
            }

            function renderStats(data) {
                var week = data.queries_this_week ?? data.total_queries ?? 0;
                var today = data.queries_today ?? 0;
                var fallback = data.fallback_count ?? 0;
                var statWeek = document.getElementById('statWeek');
                var statToday = document.getElementById('statToday');
                var statFallback = document.getElementById('statFallback');
                if (statWeek) statWeek.textContent = week;
                if (statToday) statToday.textContent = today;
                if (statFallback) statFallback.textContent = fallback;
                var trendEl = document.getElementById('statTrend');
                var trend = data.trend;
                var pct = data.trend_pct;
                if (trendEl) {
                    if (trend && trend !== 'flat' && pct !== undefined) {
                        trendEl.textContent = (trend === 'up' ? '‚Üë ' : '‚Üì ') + Math.abs(pct) + '%';
                        trendEl.className = 'trend ' + (trend === 'up' ? 'up' : 'down');
                    } else {
                        trendEl.textContent = '';
                        trendEl.className = 'trend';
                    }
                }
            }

            function renderChart(dailyData, busiestDay) {
                var wrap = document.getElementById('statsSection');
                if (!wrap) return;
                var chartWrap = wrap.querySelector('.chart-wrap');
                var insightEl = document.getElementById('busiestDayInsight');
                var hasData = dailyData && dailyData.length > 0 && dailyData.some(function (d) { return d.count > 0; });
                if (chart) { chart.destroy(); chart = null; }
                if (!hasData) {
                    if (insightEl) insightEl.textContent = '';
                    return;
                }
                var ctx = document.getElementById('dailyChart');
                if (!ctx) return;
                var labels = dailyData.map(function (d) {
                    var dte = new Date(d.date);
                    return dte.toLocaleDateString('en-AU', { weekday: 'short' });
                });
                var counts = dailyData.map(function (d) { return d.count; });
                chart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Questions',
                            data: counts,
                            backgroundColor: '#2563EB',
                            borderColor: '#2563EB',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { precision: 0 } },
                            x: { ticks: { maxRotation: 45 } }
                        }
                    }
                });
                if (insightEl && busiestDay && busiestDay !== 'N/A')
                    insightEl.textContent = 'Your busiest day is ' + busiestDay;
                else if (insightEl) insightEl.textContent = '';
            }

            function refresh() {
                hideError();
                document.body.classList.add('loading');
                var wrap = document.getElementById('spinnerWrap');
                if (wrap) { wrap.classList.add('visible'); }
                loadDashboard(currentPeriod)
                    .then(function (data) {
                        renderStats(data);
                        return loadDaily(currentPeriod).then(function (daily) {
                            renderChart(daily, data.busiest_day);
                        });
                    })
                    .catch(function (err) {
                        showError(err.message || 'Could not load dashboard');
                    })
                    .finally(function () {
                        document.body.classList.remove('loading');
                        if (wrap) wrap.classList.remove('visible');
                    });
            }

            function showEmptyState() {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('statsSection').style.display = 'none';
            }
            function showStatsState() {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('statsSection').style.display = 'block';
            }

            loadMe()
                .then(function (me) {
                    var name = (me.display_name || me.email || 'there').trim() || 'there';
                    tenantName = (me.tenant_name || me.tenant_id || '').trim();
                    tenantId = (me.tenant_id || '').trim();
                    document.getElementById('greeting').textContent = "G'day, " + name + ' üëã';
                    document.getElementById('tenantName').textContent = tenantName || '‚Äì';
                    setEmbedSnippet();
                    return loadDashboard('30d');
                })
                .then(function (data30) {
                    hasAnyData = (data30 && (data30.total_queries || 0) > 0);
                    if (hasAnyData) {
                        showStatsState();
                        refresh();
                    } else {
                        showEmptyState();
                        setEmbedSnippet();
                    }
                    return loadFaqs();
                })
                .catch(function (err) {
                    showError(err.message || 'Could not load');
                    showEmptyState();
                });

            document.querySelectorAll('.period-tabs button').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    currentPeriod = this.getAttribute('data-period');
                    document.querySelectorAll('.period-tabs button').forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    if (hasAnyData) refresh();
                });
            });

            document.getElementById('logoutBtn').addEventListener('click', function () {
                localStorage.removeItem('owner_token');
                window.location.href = '/dashboard/login';
            });

            function copyText(text, btn, doneLabel) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function () {
                        btn.textContent = doneLabel || 'Copied! ‚úì';
                        setTimeout(function () { btn.textContent = 'Copy'; }, 2000);
                    }).catch(fallback);
                } else fallback();
                function fallback() {
                    var ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.opacity = '0';
                    document.body.appendChild(ta);
                    ta.select();
                    try {
                        if (document.execCommand('copy')) {
                            btn.textContent = doneLabel || 'Copied! ‚úì';
                            setTimeout(function () { btn.textContent = 'Copy'; }, 2000);
                        }
                    } catch (e) {}
                    document.body.removeChild(ta);
                }
            }

            document.getElementById('copyEmbedBtn').addEventListener('click', function () {
                var pre = document.getElementById('embedSnippet');
                if (pre) {
                    copyText(pre.textContent, this, 'Copied! ‚úì');
                    this.classList.add('copied');
                    setTimeout(function (btn) { btn.classList.remove('copied'); }, 2000, this);
                }
            });

            document.getElementById('emptyStateCopy').addEventListener('click', function () {
                var pre = document.getElementById('emptyStateSnippet');
                if (pre) {
                    copyText(pre.textContent, this, 'Copied! ‚úì');
                    this.classList.add('copied');
                    setTimeout(function (btn) { btn.classList.remove('copied'); }, 2000, this);
                }
            });

            document.getElementById('addFaqLink').addEventListener('click', function (e) {
                e.preventDefault();
                document.getElementById('faqSection').scrollIntoView({ behavior: 'smooth' });
                var addBtn = document.getElementById('faqAddBtn');
                if (addBtn && document.getElementById('faqAddForm').style.display === 'none') addBtn.click();
            });

            // ---------- Owner FAQ self-service ----------
            var faqs = [];
            var editingFaqId = null;

            function loadFaqs() {
                return fetch('/owner/faqs', { headers: authHeaders() }).then(function (res) {
                    if (res.status === 401) return Promise.reject(new Error('Unauthorized'));
                    if (!res.ok) return Promise.reject(new Error('Failed to load FAQs'));
                    return res.json();
                }).then(function (data) {
                    faqs = (data && data.faqs) ? data.faqs : [];
                    renderFaqList();
                });
            }

            function renderFaqList() {
                var list = document.getElementById('faqList');
                var emptyState = document.getElementById('faqEmptyState');
                var addBtn = document.getElementById('faqAddBtn');
                if (!list) return;
                list.innerHTML = '';
                if (faqs.length === 0) {
                    if (emptyState) emptyState.style.display = 'block';
                    if (addBtn) addBtn.style.display = 'none';
                    return;
                }
                if (emptyState) emptyState.style.display = 'none';
                if (addBtn) addBtn.style.display = 'block';
                faqs.forEach(function (faq) {
                    var card = document.createElement('div');
                    card.className = 'faq-card' + (editingFaqId === faq.id ? ' editing' : '');
                    card.dataset.faqId = faq.id;
                    if (editingFaqId === faq.id) {
                        card.innerHTML =
                            '<label>Question:</label>' +
                            '<input type="text" class="faq-edit-question" value="' + escapeHtml(faq.question) + '" />' +
                            '<label>Answer:</label>' +
                            '<textarea class="faq-edit-answer" rows="4">' + escapeHtml(faq.answer) + '</textarea>' +
                            '<div class="faq-form-actions">' +
                            '<button type="button" class="faq-save-btn faq-save-edit-btn">Save</button>' +
                            '<button type="button" class="faq-cancel-edit-btn">Cancel</button>' +
                            '</div>';
                        card.querySelector('.faq-save-edit-btn').addEventListener('click', function () { saveEditFaq(faq.id, card); });
                        card.querySelector('.faq-cancel-edit-btn').addEventListener('click', function () { cancelEdit(); });
                    } else {
                        card.innerHTML =
                            '<div class="faq-q">Q: ' + escapeHtml(faq.question) + '</div>' +
                            '<div class="faq-a">A: ' + escapeHtml(faq.answer) + '</div>' +
                            '<div class="faq-card-actions">' +
                            '<button type="button" class="faq-edit-btn">Edit</button>' +
                            '<button type="button" class="faq-delete-btn">Delete</button>' +
                            '</div>';
                        card.querySelector('.faq-edit-btn').addEventListener('click', function () { startEdit(faq.id); });
                        card.querySelector('.faq-delete-btn').addEventListener('click', function () { confirmDelete(faq.id, faq.question); });
                    }
                    list.appendChild(card);
                });
            }

            function escapeHtml(s) {
                if (s == null) return '';
                var d = document.createElement('div');
                d.textContent = s;
                return d.innerHTML;
            }

            function showFaqWarning(msg) {
                var el = document.getElementById('faqWarningBanner');
                if (!el) return;
                el.textContent = msg ? '‚ö†Ô∏è ' + msg : '';
                el.style.display = msg ? 'block' : 'none';
            }

            function showFaqSuccess(msg) {
                var el = document.getElementById('faqWarningBanner');
                if (!el) return;
                el.style.background = '#d1fae5';
                el.style.color = '#065f46';
                el.textContent = msg || '‚úì Saved';
                el.style.display = 'block';
                setTimeout(function () {
                    el.style.background = '';
                    el.style.color = '';
                    showFaqWarning(null);
                }, 2000);
            }

            function startEdit(id) {
                editingFaqId = id;
                renderFaqList();
            }

            function cancelEdit() {
                editingFaqId = null;
                renderFaqList();
            }

            function saveEditFaq(id, cardEl) {
                var q = (cardEl.querySelector('.faq-edit-question') || {}).value || '';
                var a = (cardEl.querySelector('.faq-edit-answer') || {}).value || '';
                if (!q.trim() || !a.trim()) { showFaqWarning('Question and answer are required.'); return; }
                var btn = cardEl.querySelector('.faq-save-edit-btn');
                if (btn) { btn.disabled = true; btn.textContent = 'Updating...'; }
                fetch('/owner/faqs/' + id, {
                    method: 'PUT',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, authHeaders()),
                    body: JSON.stringify({ question: q.trim(), answer: a.trim() })
                }).then(function (res) {
                    return res.json().then(function (data) {
                        if (!res.ok) throw new Error(data.detail || data.message || 'Update failed');
                        return data;
                    });
                }).then(function (data) {
                    editingFaqId = null;
                    if (data.warning) showFaqWarning(data.warning);
                    else showFaqWarning(null);
                    showFaqSuccess('‚úì Done');
                    loadFaqs();
                }).catch(function (err) {
                    showFaqWarning(err.message || 'Update failed');
                    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
                });
            }

            function confirmDelete(id, question) {
                if (!confirm('Remove this question? Your widget won\'t be able to answer it anymore.')) return;
                fetch('/owner/faqs/' + id, { method: 'DELETE', headers: authHeaders() })
                    .then(function (res) {
                        if (!res.ok) return res.json().then(function (d) { throw new Error(d.detail || 'Delete failed'); });
                        return res.json();
                    })
                    .then(function () {
                        showFaqWarning(null);
                        loadFaqs();
                    })
                    .catch(function (err) {
                        showFaqWarning(err.message || 'Delete failed');
                    });
            }

            function toggleAddForm(show) {
                var form = document.getElementById('faqAddForm');
                if (!form) return;
                form.style.display = show ? 'block' : 'none';
                if (show) {
                    document.getElementById('faqNewQuestion').value = '';
                    document.getElementById('faqNewAnswer').value = '';
                    showFaqWarning(null);
                }
            }

            function saveNewFaq() {
                var q = (document.getElementById('faqNewQuestion') || {}).value || '';
                var a = (document.getElementById('faqNewAnswer') || {}).value || '';
                if (!q.trim() || !a.trim()) { showFaqWarning('Question and answer are required.'); return; }
                var btn = document.getElementById('faqSaveNewBtn');
                if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }
                fetch('/owner/faqs', {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, authHeaders()),
                    body: JSON.stringify({ question: q.trim(), answer: a.trim() })
                }).then(function (res) {
                    return res.json().then(function (data) {
                        if (!res.ok) throw new Error(data.detail || data.message || 'Save failed');
                        return data;
                    });
                }).then(function (data) {
                    if (data.warning) showFaqWarning(data.warning);
                    else showFaqWarning(null);
                    showFaqSuccess('‚úì Saved');
                    toggleAddForm(false);
                    loadFaqs();
                }).catch(function (err) {
                    showFaqWarning(err.message || 'Save failed');
                }).finally(function () {
                    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
                });
            }

            document.getElementById('faqAddBtn').addEventListener('click', function () { toggleAddForm(document.getElementById('faqAddForm').style.display !== 'block'); });
            document.getElementById('faqAddBtnEmpty').addEventListener('click', function () {
                document.getElementById('faqEmptyState').style.display = 'none';
                toggleAddForm(true);
            });
            document.getElementById('faqSaveNewBtn').addEventListener('click', saveNewFaq);
            document.getElementById('faqCancelNewBtn').addEventListener('click', function () { toggleAddForm(false); });
        })();
    </script>
</body>
</html>

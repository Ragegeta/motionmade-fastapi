<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotionMade â€“ Your Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1f2937;
            padding: 20px;
            font-size: 16px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            gap: 16px;
        }
        .header-text h1 { font-size: 22px; color: #111827; }
        .header-text .tenant { color: #6b7280; font-size: 14px; margin-top: 4px; }
        .logout {
            padding: 10px 18px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            min-height: 44px;
        }
        .logout:hover { background: #e5e7eb; }
        .period-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        .period-tabs button {
            padding: 10px 18px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            min-height: 44px;
        }
        .period-tabs button.active {
            background: #2563EB;
            color: white;
            border-color: #2563EB;
        }
        .period-tabs button:not(.active):hover { background: #f9fafb; }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .card .label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .card .value {
            font-size: 48px;
            font-weight: 700;
            color: #111827;
            line-height: 1.1;
        }
        @media (max-width: 400px) {
            .card .value { font-size: 40px; }
        }
        .card .trend {
            font-size: 14px;
            margin-top: 6px;
        }
        .card .trend.up { color: #059669; }
        .card .trend.down { color: #dc2626; }
        .card a {
            color: #2563EB;
            font-size: 14px;
            margin-top: 8px;
            display: inline-block;
        }
        .chart-wrap {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .chart-wrap h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #374151;
        }
        .chart-container { position: relative; height: 260px; min-height: 200px; }
        .chart-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #6b7280;
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }
        .embed-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .embed-section h2 { font-size: 18px; margin-bottom: 12px; color: #374151; }
        .embed-section p { color: #6b7280; font-size: 14px; margin-bottom: 12px; }
        .embed-code {
            background: #f3f4f6;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            font-size: 12px;
            background: #2563EB;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .copy-btn:hover { background: #1d4ed8; }
        footer {
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
            padding: 24px 0;
        }
        .help-text { color: #6b7280; font-size: 14px; margin-top: 16px; }
        #dashboardError {
            background: #fef2f2;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .loading { opacity: 0.7; pointer-events: none; }
        .spinner-wrap {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
            pointer-events: none;
        }
        .spinner-wrap.visible { display: block; }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563EB;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="spinner-wrap" id="spinnerWrap" aria-hidden="true">
        <div class="spinner"></div>
    </div>
    <div class="container">
        <div id="dashboardError" style="display: none;"></div>
        <header>
            <div class="header-text">
                <h1 id="greeting">G'day ðŸ‘‹</h1>
                <div class="tenant" id="tenantName">â€“</div>
            </div>
            <button type="button" class="logout" id="logoutBtn">Log out</button>
        </header>
        <div class="period-tabs">
            <button type="button" data-period="7d" class="active">Last 7 days</button>
            <button type="button" data-period="30d">Last 30 days</button>
            <button type="button" data-period="90d">Last 90 days</button>
        </div>
        <div class="cards">
            <div class="card">
                <div class="label">Questions answered this week</div>
                <div class="value" id="statWeek">â€“</div>
                <div class="trend" id="statTrend"></div>
            </div>
            <div class="card">
                <div class="label">Answered today</div>
                <div class="value" id="statToday">â€“</div>
            </div>
            <div class="card">
                <div class="label">Couldn't answer</div>
                <div class="value" id="statFallback">â€“</div>
                <a href="#" id="addFaqLink">Add more FAQs?</a>
            </div>
        </div>
        <div class="chart-wrap">
            <h2>Questions per day</h2>
            <div class="chart-container">
                <div class="chart-empty" id="chartEmpty" style="display: none;">No data yet â€” queries will appear here once your widget is live.</div>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
        <div class="embed-section">
            <h2>Your chat widget</h2>
            <p>Add this snippet to your website to show the chat bubble.</p>
            <div class="embed-code">
                <button type="button" class="copy-btn" id="copyEmbedBtn">Copy</button>
                <pre id="embedSnippet">&lt;script src="https://YOUR_WIDGET_URL/widget.js" data-tenant="YOUR_TENANT_ID"&gt;&lt;/script&gt;</pre>
            </div>
        </div>
        <p class="help-text">Need help? Text Abbed at 04XXXXXXXX</p>
        <footer>Powered by MotionMade AI</footer>
    </div>
    <script>
        (function () {
            var token = localStorage.getItem('owner_token');
            if (!token) {
                window.location.href = '/dashboard/login';
                return;
            }
            var currentPeriod = '7d';
            var chart = null;
            var tenantId = '';

            function authHeaders() {
                return { 'Authorization': 'Bearer ' + token };
            }

            function showError(msg) {
                var el = document.getElementById('dashboardError');
                el.textContent = msg;
                el.style.display = 'block';
            }
            function hideError() {
                document.getElementById('dashboardError').style.display = 'none';
            }

            function loadMe() {
                return fetch('/owner/me', { headers: authHeaders() }).then(function (res) {
                    if (res.status === 401) {
                        localStorage.removeItem('owner_token');
                        window.location.href = '/dashboard/login';
                        throw new Error('Session expired');
                    }
                    if (!res.ok) throw new Error('Failed to load profile');
                    return res.json();
                });
            }

            function loadDashboard(period) {
                return fetch('/owner/dashboard?period=' + (period || currentPeriod), { headers: authHeaders() })
                    .then(function (res) {
                        if (res.status === 401) {
                            localStorage.removeItem('owner_token');
                            window.location.href = '/dashboard/login';
                            throw new Error('Session expired');
                        }
                        if (!res.ok) throw new Error('Failed to load stats');
                        return res.json();
                    });
            }

            function loadDaily(period) {
                return fetch('/owner/dashboard/daily?period=' + (period || currentPeriod), { headers: authHeaders() })
                    .then(function (res) {
                        if (!res.ok) return [];
                        return res.json();
                    });
            }

            function renderStats(data) {
                document.getElementById('statWeek').textContent = data.queries_this_week ?? data.total_queries ?? '0';
                document.getElementById('statToday').textContent = data.queries_today ?? '0';
                document.getElementById('statFallback').textContent = data.fallback_count ?? '0';
                var trendEl = document.getElementById('statTrend');
                var trend = data.trend;
                var pct = data.trend_pct;
                if (trend && pct !== undefined) {
                    trendEl.textContent = (trend === 'up' ? 'â†‘' : trend === 'down' ? 'â†“' : '') + (pct ? Math.abs(pct) + '%' : '');
                    trendEl.className = 'trend ' + (trend === 'up' ? 'up' : trend === 'down' ? 'down' : '');
                } else {
                    trendEl.textContent = '';
                }
            }

            function renderChart(dailyData) {
                var emptyEl = document.getElementById('chartEmpty');
                var canvas = document.getElementById('dailyChart');
                var hasData = (dailyData && dailyData.length > 0 && dailyData.some(function (d) { return d.count > 0; }));
                if (chart) { chart.destroy(); chart = null; }
                if (!hasData) {
                    emptyEl.style.display = 'flex';
                    canvas.style.display = 'none';
                    return;
                }
                emptyEl.style.display = 'none';
                canvas.style.display = 'block';
                var ctx = canvas.getContext('2d');
                var labels = dailyData.map(function (d) {
                    var dte = new Date(d.date);
                    return dte.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short' });
                });
                var counts = dailyData.map(function (d) { return d.count; });
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Questions',
                            data: counts,
                            backgroundColor: 'rgba(37, 99, 235, 0.6)',
                            borderColor: '#2563EB',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { precision: 0 } },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
            }

            function setEmbedSnippet() {
                var base = window.location.origin;
                var snippet = '<script src="' + base + '/static/widget.js" data-tenant="' + (tenantId || 'YOUR_TENANT_ID') + '"><\/script>';
                document.getElementById('embedSnippet').textContent = snippet;
            }

            function refresh() {
                hideError();
                document.body.classList.add('loading');
                var wrap = document.getElementById('spinnerWrap');
                if (wrap) { wrap.classList.add('visible'); wrap.setAttribute('aria-hidden', 'false'); }
                loadDashboard(currentPeriod)
                    .then(function (data) {
                        renderStats(data);
                        return loadDaily(currentPeriod);
                    })
                    .then(function (daily) {
                        renderChart(daily);
                    })
                    .catch(function (err) {
                        showError(err.message || 'Could not load dashboard');
                    })
                    .finally(function () {
                        document.body.classList.remove('loading');
                        var w = document.getElementById('spinnerWrap');
                        if (w) { w.classList.remove('visible'); w.setAttribute('aria-hidden', 'true'); }
                    });
            }

            loadMe()
                .then(function (me) {
                    var name = (me.display_name || me.email || 'there').trim() || 'there';
                    document.getElementById('greeting').textContent = "G'day, " + name + ' ðŸ‘‹';
                    document.getElementById('tenantName').textContent = me.tenant_name || me.tenant_id || '';
                    tenantId = me.tenant_id || '';
                    setEmbedSnippet();
                    refresh();
                })
                .catch(function () {});

            document.querySelectorAll('.period-tabs button').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    currentPeriod = this.getAttribute('data-period');
                    document.querySelectorAll('.period-tabs button').forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    refresh();
                });
            });

            document.getElementById('logoutBtn').addEventListener('click', function () {
                localStorage.removeItem('owner_token');
                window.location.href = '/dashboard/login';
            });

            document.getElementById('copyEmbedBtn').addEventListener('click', function () {
                var pre = document.getElementById('embedSnippet');
                var text = pre.textContent;
                var btn = document.getElementById('copyEmbedBtn');
                function showCopied() {
                    btn.textContent = 'Copied!';
                    setTimeout(function () { btn.textContent = 'Copy'; }, 2000);
                }
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(showCopied).catch(function () {
                        fallbackCopy(text, showCopied);
                    });
                } else {
                    fallbackCopy(text, showCopied);
                }
            });
            function fallbackCopy(text, done) {
                var ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                try {
                    if (document.execCommand('copy')) done();
                } catch (e) {}
                document.body.removeChild(ta);
            }

            document.getElementById('addFaqLink').addEventListener('click', function (e) {
                e.preventDefault();
                alert('Contact your account manager to add more FAQs to your chat widget.');
            });
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ Admin - Tenant Management</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #333; }
        .auth-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .auth-section input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            margin-right: 10px;
        }
        .auth-section button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .auth-section button:hover { background: #0056b3; }
        .error { color: #dc3545; margin-top: 10px; }
        .success { color: #28a745; margin-top: 10px; }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .tenants-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .tenants-list table {
            width: 100%;
            border-collapse: collapse;
        }
        .tenants-list th,
        .tenants-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .tenants-list th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .tenants-list tr:hover { background: #f8f9fa; }
        .tenants-list button {
            padding: 4px 8px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .tenant-detail {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .section:last-child { border-bottom: none; }
        .section h2 { margin-bottom: 15px; color: #333; }
        .section h3 { margin-bottom: 10px; color: #666; font-size: 14px; }
        
        .domains-list {
            list-style: none;
        }
        .domains-list li {
            padding: 8px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .domains-list button {
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        .form-group textarea {
            min-height: 100px;
            font-family: monospace;
        }
        
        button.primary {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button.primary:hover { background: #218838; }
        button.secondary {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button.secondary:hover { background: #5a6268; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        .stat-card .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #007bff;
            text-decoration: none;
        }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>FAQ Admin - Tenant Management</h1>
        
        <!-- Auth Section -->
        <div class="auth-section" id="authSection">
            <h2>Login</h2>
            <input type="password" id="adminToken" placeholder="Enter admin token" />
            <button onclick="login()">Login</button>
            <div id="authError" class="error"></div>
        </div>
        
        <!-- Tenants List Page -->
        <div class="page" id="tenantsPage">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Tenants</h2>
                <button class="primary" onclick="showCreateTenant()">+ New Tenant</button>
            </div>
            <div class="tenants-list">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tenantsTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Tenant Detail Page -->
        <div class="page" id="tenantDetailPage">
            <a href="#" class="back-link" onclick="showTenantsList()">← Back to Tenants</a>
            <div class="tenant-detail" id="tenantDetail"></div>
        </div>
        
        <!-- Create Tenant Modal -->
        <div class="page" id="createTenantPage">
            <a href="#" class="back-link" onclick="showTenantsList()">← Back to Tenants</a>
            <div class="tenant-detail">
                <h2>Create New Tenant</h2>
                <div class="form-group">
                    <label>Tenant ID</label>
                    <input type="text" id="newTenantId" placeholder="e.g., my_business" />
                </div>
                <div class="form-group">
                    <label>Tenant Name</label>
                    <input type="text" id="newTenantName" placeholder="My Business Name" />
                </div>
                <button class="primary" onclick="createTenant()">Create Tenant</button>
                <div id="createError" class="error"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let adminToken = '';
        
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`
            };
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }
        
        function login() {
            const token = document.getElementById('adminToken').value;
            if (!token) {
                document.getElementById('authError').textContent = 'Token required';
                return;
            }
            
            adminToken = token;
            document.getElementById('authSection').style.display = 'none';
            loadTenants();
        }
        
        async function loadTenants() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/tenants`, {
                    headers: getHeaders()
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                const tbody = document.getElementById('tenantsTable');
                tbody.innerHTML = '';
                
                data.tenants.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${escapeHtml(t.id)}</td>
                        <td>${escapeHtml(t.name)}</td>
                        <td>${t.created_at ? new Date(t.created_at).toLocaleDateString() : ''}</td>
                        <td><button onclick="showTenantDetail('${escapeHtml(t.id)}')">View</button></td>
                    `;
                    tbody.appendChild(tr);
                });
                
                showPage('tenantsPage');
            } catch (e) {
                document.getElementById('authError').textContent = `Error: ${e.message}`;
                document.getElementById('authSection').style.display = 'block';
            }
        }
        
        async function showTenantDetail(tenantId) {
            try {
                const [tenantRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/admin/api/tenant/${tenantId}`, { headers: getHeaders() }),
                    fetch(`${API_BASE}/admin/api/tenant/${tenantId}/stats`, { headers: getHeaders() }).catch(() => null)
                ]);
                
                if (!tenantRes.ok) throw new Error(`HTTP ${tenantRes.status}`);
                const tenant = await tenantRes.json();
                const stats = statsRes && statsRes.ok ? await statsRes.json() : null;
                
                const detailDiv = document.getElementById('tenantDetail');
                detailDiv.innerHTML = `
                    <h1>${escapeHtml(tenant.name || tenant.id)}</h1>
                    <p style="color: #666; margin-bottom: 20px;">ID: ${escapeHtml(tenant.id)}</p>
                    
                    <div class="section">
                        <h2>Domains</h2>
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <input type="text" id="newDomain" placeholder="example.com" style="flex: 1;" />
                            <button class="primary" onclick="addDomain('${escapeHtml(tenant.id)}')">Add Domain</button>
                        </div>
                        <ul class="domains-list" id="domainsList">
                            ${tenant.domains.map(d => `
                                <li>
                                    <span>${escapeHtml(d.domain)} ${d.enabled ? '✓' : '✗'}</span>
                                    <button onclick="removeDomain('${escapeHtml(tenant.id)}', '${escapeHtml(d.domain)}')">Remove</button>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="section">
                        <h2>FAQs</h2>
                        <div style="margin-bottom: 15px;">
                            <p style="color: #666; margin-bottom: 10px;">
                                Live: ${tenant.live_faq_count || 0} | 
                                Staged: ${tenant.staged_faq_count || 0} | 
                                Last Good: ${tenant.last_good_count || 0}
                            </p>
                            ${tenant.last_run ? `
                                <p style="margin-bottom: 10px;">
                                    <strong>Last Run:</strong> 
                                    <span style="color: ${tenant.last_run.status === 'success' ? '#28a745' : '#dc3545'};">
                                        ${tenant.last_run.status.toUpperCase()}
                                    </span>
                                    ${tenant.last_run.created_at ? `(${new Date(tenant.last_run.created_at).toLocaleString()})` : ''}
                                </p>
                            ` : ''}
                        </div>
                        <div class="form-group">
                            <label>Upload Staged FAQs (JSON)</label>
                            <textarea id="stagedFaqsJson" placeholder='[{"question": "Q1", "answer": "A1", "variants": ["v1"]}]'></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="primary" onclick="uploadStagedFaqs('${escapeHtml(tenant.id)}')">Upload Staged</button>
                            <button class="secondary" onclick="runSuite('${escapeHtml(tenant.id)}')">Run Suite</button>
                            <button class="primary" onclick="promoteStaged('${escapeHtml(tenant.id)}')" ${tenant.staged_faq_count == 0 ? 'disabled' : ''}>Promote</button>
                            <button class="secondary" onclick="rollbackTenant('${escapeHtml(tenant.id)}')" ${tenant.last_good_count == 0 ? 'disabled' : ''}>Rollback</button>
                        </div>
                        <div id="faqsError" class="error"></div>
                        <div id="faqsSuccess" class="success"></div>
                    </div>
                    
                    <div class="section">
                        <h2>Stats (Last 24 Hours)</h2>
                        ${stats ? `
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="label">Total Queries</div>
                                    <div class="value">${stats.total_queries}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="label">FAQ Hit Rate</div>
                                    <div class="value">${(stats.faq_hit_rate * 100).toFixed(1)}%</div>
                                </div>
                                <div class="stat-card">
                                    <div class="label">Clarify Rate</div>
                                    <div class="value">${(stats.clarify_rate * 100).toFixed(1)}%</div>
                                </div>
                                <div class="stat-card">
                                    <div class="label">Fallback Rate</div>
                                    <div class="value">${(stats.fallback_rate * 100).toFixed(1)}%</div>
                                </div>
                                <div class="stat-card">
                                    <div class="label">Rewrite Rate</div>
                                    <div class="value">${(stats.rewrite_rate * 100).toFixed(1)}%</div>
                                </div>
                                <div class="stat-card">
                                    <div class="label">Avg Latency</div>
                                    <div class="value">${stats.avg_latency_ms}ms</div>
                                </div>
                            </div>
                        ` : '<p style="color: #666;">No stats available</p>'}
                    </div>
                    
                    <div class="section">
                        <h2>Install Snippet</h2>
                        <p style="color: #666; margin-bottom: 15px;">Copy and paste this script tag into your website, just before the closing <code>&lt;/body&gt;</code> tag:</p>
                        
                        <div class="form-group">
                            <label>Widget URL</label>
                            <input type="text" id="installApiBase" value="https://api.motionmadebne.com.au" placeholder="API base URL" oninput="updateInstallSnippet()" />
                        </div>
                        <div class="form-group">
                            <label>Greeting Message</label>
                            <input type="text" id="installGreeting" value="Hi! How can I help you today?" placeholder="Initial greeting" oninput="updateInstallSnippet()" />
                        </div>
                        <div class="form-group">
                            <label>Header Text</label>
                            <input type="text" id="installHeader" value="Chat with us" placeholder="Chat header" oninput="updateInstallSnippet()" />
                        </div>
                        <div class="form-group">
                            <label>Color (hex)</label>
                            <input type="text" id="installColor" value="#2563eb" placeholder="#2563eb" oninput="updateInstallSnippet()" />
                        </div>
                        <div class="form-group">
                            <label>Position</label>
                            <select id="installPosition" onchange="updateInstallSnippet()">
                                <option value="bottom-right" selected>Bottom Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="top-left">Top Left</option>
                            </select>
                        </div>
                        
                        <div style="margin-top: 15px; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <code id="installSnippet" style="background: #f8f9fa; padding: 12px; display: block; flex: 1; border-radius: 4px; font-family: monospace; font-size: 13px; white-space: pre-wrap; word-break: break-all;"></code>
                                <button id="copyButton" class="primary" onclick="copyInstallSnippet()" style="white-space: nowrap;">Copy</button>
                            </div>
                            <div id="copySuccess" style="color: #28a745; font-size: 12px; display: none;">✓ Copied!</div>
                        </div>
                        
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 13px;">
                            <strong>Note:</strong> Paste this snippet before the closing <code>&lt;/body&gt;</code> tag. If you use Content Security Policy (CSP), allowlist:
                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                <li><code>https://mm-client1-creator-ui.pages.dev</code> (widget.js source)</li>
                                <li><code>https://api.motionmadebne.com.au</code> (API endpoint)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Actions</h2>
                        <p style="color: #666; margin-bottom: 10px;">For suite runs and promote/rollback, use the pipeline script:</p>
                        <code style="background: #f8f9fa; padding: 10px; display: block; border-radius: 4px; margin-bottom: 10px;">
                            .\run_faq_pipeline.ps1 -TenantId ${escapeHtml(tenant.id)}
                        </code>
                    </div>
                `;
                
                // Initialize install snippet
                updateInstallSnippet();
                
                showPage('tenantDetailPage');
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }
        
        async function addDomain(tenantId) {
            const domain = document.getElementById('newDomain').value.trim();
            if (!domain) {
                alert('Domain required');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/tenant/${tenantId}/domains`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ domain })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                showTenantDetail(tenantId);
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }
        
        async function removeDomain(tenantId, domain) {
            if (!confirm(`Remove domain ${domain}?`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/tenant/${tenantId}/domains/${encodeURIComponent(domain)}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                showTenantDetail(tenantId);
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }
        
        async function uploadStagedFaqs(tenantId) {
            const jsonText = document.getElementById('stagedFaqsJson').value.trim();
            if (!jsonText) {
                document.getElementById('faqsError').textContent = 'FAQ JSON required';
                return;
            }
            
            let items;
            try {
                items = JSON.parse(jsonText);
            } catch (e) {
                document.getElementById('faqsError').textContent = `Invalid JSON: ${e.message}`;
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/tenant/${tenantId}/faqs/staged`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(items)
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }
                const data = await res.json();
                document.getElementById('faqsError').textContent = '';
                document.getElementById('faqsSuccess').textContent = `Staged ${data.staged_count} FAQs successfully`;
                setTimeout(() => showTenantDetail(tenantId), 1000);
            } catch (e) {
                document.getElementById('faqsError').textContent = `Error: ${e.message}`;
                document.getElementById('faqsSuccess').textContent = '';
            }
        }
        
        async function runSuite(tenantId) {
            document.getElementById('faqsError').textContent = '';
            document.getElementById('faqsSuccess').textContent = 'Running suite...';
            
            try {
                // Run suite by promoting (which runs suite internally)
                const res = await fetch(`${API_BASE}/admin/api/tenant/${tenantId}/promote`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('faqsSuccess').textContent = `Suite passed: ${data.suite_result.passed_count}/${data.suite_result.total} tests`;
                } else {
                    document.getElementById('faqsError').textContent = `Suite failed: ${data.suite_result.failed_count}/${data.suite_result.total} tests failed`;
                    if (data.first_failure) {
                        document.getElementById('faqsError').textContent += `\nFirst failure: ${data.first_failure.test_name || 'unknown'}`;
                    }
                }
                setTimeout(() => showTenantDetail(tenantId), 2000);
            } catch (e) {
                document.getElementById('faqsError').textContent = `Error: ${e.message}`;
                document.getElementById('faqsSuccess').textContent = '';
            }
        }
        
        async function promoteStaged(tenantId) {
            if (!confirm('Promote staged FAQs to live? This will run the test suite first.')) return;
            
            document.getElementById('faqsError').textContent = '';
            document.getElementById('faqsSuccess').textContent = 'Promoting...';
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/tenant/${tenantId}/promote`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('faqsSuccess').textContent = data.message;
                } else {
                    document.getElementById('faqsError').textContent = data.message;
                    if (data.first_failure) {
                        document.getElementById('faqsError').textContent += `\nFirst failure: ${data.first_failure.test_name || 'unknown'}`;
                    }
                }
                setTimeout(() => showTenantDetail(tenantId), 2000);
            } catch (e) {
                document.getElementById('faqsError').textContent = `Error: ${e.message}`;
                document.getElementById('faqsSuccess').textContent = '';
            }
        }
        
        async function rollbackTenant(tenantId) {
            if (!confirm('Rollback to last_good FAQs? This will replace current live FAQs.')) return;
            
            document.getElementById('faqsError').textContent = '';
            document.getElementById('faqsSuccess').textContent = 'Rolling back...';
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/tenant/${tenantId}/rollback`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('faqsSuccess').textContent = data.message;
                } else {
                    document.getElementById('faqsError').textContent = `Error: ${data.message || 'Unknown error'}`;
                }
                setTimeout(() => showTenantDetail(tenantId), 1000);
            } catch (e) {
                document.getElementById('faqsError').textContent = `Error: ${e.message}`;
                document.getElementById('faqsSuccess').textContent = '';
            }
        }
        
        function showCreateTenant() {
            showPage('createTenantPage');
        }
        
        async function createTenant() {
            const id = document.getElementById('newTenantId').value.trim();
            const name = document.getElementById('newTenantName').value.trim();
            
            if (!id) {
                document.getElementById('createError').textContent = 'Tenant ID required';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/tenants`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ id, name: name || id })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }
                loadTenants();
            } catch (e) {
                document.getElementById('createError').textContent = `Error: ${e.message}`;
            }
        }
        
        function showTenantsList() {
            loadTenants();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function updateInstallSnippet() {
            const apiBase = document.getElementById('installApiBase')?.value || 'https://api.motionmadebne.com.au';
            const greeting = document.getElementById('installGreeting')?.value || 'Hi! How can I help you today?';
            const header = document.getElementById('installHeader')?.value || 'Chat with us';
            const color = document.getElementById('installColor')?.value || '#2563eb';
            const position = document.getElementById('installPosition')?.value || 'bottom-right';
            
            const snippet = `<script src="https://mm-client1-creator-ui.pages.dev/widget.js"
          data-api="${escapeHtml(apiBase)}"
          data-greeting="${escapeHtml(greeting)}"
          data-header="${escapeHtml(header)}"
          data-color="${escapeHtml(color)}"
          data-position="${escapeHtml(position)}"></script>`;
            
            const snippetEl = document.getElementById('installSnippet');
            if (snippetEl) {
                snippetEl.textContent = snippet;
            }
        }
        
        async function copyInstallSnippet() {
            const snippetEl = document.getElementById('installSnippet');
            const copySuccess = document.getElementById('copySuccess');
            if (!snippetEl) return;
            
            try {
                await navigator.clipboard.writeText(snippetEl.textContent);
                if (copySuccess) {
                    copySuccess.style.display = 'block';
                    setTimeout(() => {
                        copySuccess.style.display = 'none';
                    }, 2000);
                }
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = snippetEl.textContent;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    if (copySuccess) {
                        copySuccess.style.display = 'block';
                        setTimeout(() => {
                            copySuccess.style.display = 'none';
                        }, 2000);
                    }
                } catch (e) {
                    alert('Failed to copy. Please select and copy manually.');
                }
                document.body.removeChild(textArea);
            }
        }
    </script>
</body>
</html>

